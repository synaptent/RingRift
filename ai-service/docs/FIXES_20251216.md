# Pipeline Fixes - December 16, 2025

## Summary

Fixed critical training pipeline issues that were blocking model training and data collection.

## Issues Fixed

### 1. SSH Host Key Verification Failures

**Problem**: P2P data sync and model push were failing with "Host key verification failed" errors.

**Root Cause**: `StrictHostKeyChecking` was not configured, and hosts weren't in known_hosts.

**Fix**:

- Updated `app/distributed/hosts.py` and `app/distributed/unified_data_sync.py` to use `StrictHostKeyChecking=accept-new` (secure TOFU model)
- Added check for SSH key file existence before adding `-i` flag
- Created `scripts/cluster_ssh_init.py` for secure host key management using ssh-keyscan
- Ran `cluster_ssh_init.py --scan` to initialize 20/22 cluster hosts

### 2. Game Quarantine Over-Exclusion

**Problem**: 0 trainable games despite 22k+ games in database. Games were incorrectly excluded.

**Root Cause**: `quarantine_bad_games.py` excluded games with >200 moves even if they completed normally. LPS (Longest Path Score) games naturally have high move counts.

**Fix**:

- Updated quarantine logic to check `termination_reason LIKE '%completed%'` before excluding high-move games
- Added `--unquarantine` flag to restore incorrectly excluded games
- Ran unquarantine twice: restored 16,777 + 4,706 = 21,483 games
- Result: **100% of 23,678 games now trainable**

### 3. P2P Systemd Service PYTHONPATH

**Problem**: P2P orchestrator kept crashing with `ModuleNotFoundError: No module named 'app'`

**Root Cause**: Systemd service didn't set PYTHONPATH.

**Fix**:

- Updated `/etc/systemd/system/ringrift-p2p.service` to export `PYTHONPATH=$RINGRIFT_PATH/ai-service`
- Ran `systemctl daemon-reload && systemctl restart ringrift-p2p`
- P2P now running and syncing data

### 4. Training Monitor Deprecated DB Reference

**Problem**: Monitor warned about missing `all_jsonl_training.db` (deprecated file).

**Fix**:

- Removed `all_jsonl_training.db` from `key_dbs` list in `training_monitor.py`
- Fixed verbose output to show trainable/total counts (was using wrong dict key)
- Added all hex/sq19 configs to PRIORITY_CONFIGS

## Infrastructure Improvements

### Selfplay Workers Started

- 12 hex/sq19 workers (2000 games each) on Lambda
- 6 sq8_3p/4p workers (5000 games each) on Lambda
- 10 workers on 2 Vast.ai instances

### Monitoring Cron Jobs

```
*/5 * * * * python3 scripts/p2p_watchdog.py ...  # P2P health
*/15 * * * * python3 scripts/training_monitor.py --cron ...  # Pipeline health
```

### Elo Tournament

- Triggered `auto_elo_tournament.py` to evaluate new models
- Model promotion daemon running with 20 Elo threshold

## Key Files Modified

- `app/distributed/hosts.py` - SSH options
- `app/distributed/unified_data_sync.py` - SSH options
- `scripts/quarantine_bad_games.py` - Unquarantine feature
- `scripts/training_monitor.py` - Priority configs, verbose output
- `scripts/cluster_ssh_init.py` - New script
- `/etc/systemd/system/ringrift-p2p.service` - PYTHONPATH fix

## Current Status

- Training loop: Active (iter 463+), training squ2p, squ3p, squ4p
- Trainable games: 23,678 (100%)
- P2P sync: Running
- Model promotion: Active
- Selfplay workers: 30+ across Lambda and Vast.ai
