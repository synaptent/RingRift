# Parity Mismatch Debugging Runbook

**Alert:** ParityValidationFailed
**Severity:** Critical
**Component:** Rules Engine / Training Pipeline
**Team:** AI Service

---

## 1. Description

Parity mismatches occur when the Python rules engine (`ai-service/app/rules/`) produces different game states than the TypeScript rules engine (`src/shared/engine/`). Since TypeScript is the source of truth, parity failures indicate bugs in the Python implementation.

**Why it matters:**

- Training data generated by Python must match production game behavior
- Mismatches cause models to learn incorrect game dynamics
- Can lead to illegal moves or incorrect win/loss determination

---

## 2. Impact

- **Training blocked** - Cannot generate valid training data
- **Model quality degradation** - Models learn from incorrect data
- **Selfplay invalid** - Games don't reflect true game rules
- **Production bugs** - If deployed model makes illegal moves

---

## 3. Diagnosis

### 3.1 Run Parity Validation

```bash
# Validate specific database
python scripts/check_ts_python_replay_parity.py \
  --db data/games/my_games.db \
  --verbose

# Validate with state bundle emission for debugging
python scripts/check_ts_python_replay_parity.py \
  --db data/games/my_games.db \
  --emit-state-bundles-dir parity_bundles/

# Run canonical parity gate (validates all configs)
python scripts/run_canonical_selfplay_parity_gate.py --board-type hex8
```

### 3.2 Identify Divergence Point

Parity check output shows:

- **game_id**: UUID of failed game
- **diverged_at**: Move index (k) where divergence occurred
- **mismatch_kinds**: What differs (phase, board, scores, anm_state)

```json
{
  "game_id": "abc123...",
  "diverged_at": 57,
  "mismatch_kinds": ["current_phase", "board_state"],
  "python_summary": {
    "current_phase": "territory_processing",
    "state_hash": "a1b2c3d4..."
  },
  "ts_summary": {
    "current_phase": "forced_elimination",
    "state_hash": "e5f6g7h8..."
  }
}
```

### 3.3 Analyze State Bundle

```bash
# Diff state bundles at divergence point
python scripts/diff_state_bundle.py \
  --bundle parity_bundles/<game_id>.state_bundle.json \
  --k 57
```

Or programmatically:

```python
from app.utils.debug_utils import StateDiffer, load_ts_state_dump
import json

bundle = json.load(open("parity_bundles/<game_id>.state_bundle.json"))
diff = StateDiffer().diff_states(
    bundle["python_state_at_k"],
    bundle["ts_state_at_k"]
)
print(diff)
```

### 3.4 Common Mismatch Types

| Mismatch Kind      | Usually Indicates       | Check Files                            |
| ------------------ | ----------------------- | -------------------------------------- |
| `current_phase`    | Phase transition bug    | `app/rules/phase_machine.py`, `fsm.py` |
| `board_state`      | Move application bug    | `app/rules/board_manager.py`           |
| `scores`           | Scoring calculation bug | `app/rules/scoring.py`                 |
| `anm_state`        | ANM detection bug       | `app/rules/anm_detection.py`           |
| `legal_moves`      | Move generation bug     | `app/rules/move_generator.py`          |
| `collapsed_spaces` | Territory collapse bug  | `app/rules/territory.py`               |

---

## 4. Resolution

### 4.1 Reproduce Locally

```bash
# Replay specific game to divergence point
python scripts/selfplay-db-ts-replay.py \
  --db data/games/my_games.db \
  --game <game_id>

# With state dumps at specific move
RINGRIFT_TS_REPLAY_DUMP_STATE_AT_K=57 \
RINGRIFT_TS_REPLAY_DUMP_DIR=/tmp/parity_debug \
python scripts/selfplay-db-ts-replay.py \
  --db data/games/my_games.db \
  --game <game_id>
```

### 4.2 Enable Trace Logging

```bash
# Enable detailed trace logging
RINGRIFT_TRACE_DEBUG=1 python scripts/check_ts_python_replay_parity.py \
  --db data/games/my_games.db
```

In code, add tracing:

```python
# In app/rules/phase_machine.py
def advance_phases(self, game_state, last_move):
    if os.getenv("RINGRIFT_TRACE_DEBUG"):
        print(f"[TRACE] Phase before: {game_state.current_phase}")
        print(f"[TRACE] Last move: {last_move.type}")

    # ... existing code ...

    if os.getenv("RINGRIFT_TRACE_DEBUG"):
        print(f"[TRACE] Phase after: {game_state.current_phase}")
```

### 4.3 Compare Side-by-Side

```python
from app.utils.debug_utils import StateDiffer

differ = StateDiffer()

# Compare specific fields
diff = differ.diff_py_ts_state(py_state, ts_state)

# Detailed field comparison
for field, (py_val, ts_val) in diff.items():
    print(f"{field}:")
    print(f"  Python: {py_val}")
    print(f"  TypeScript: {ts_val}")
```

### 4.4 Fix Common Issues

#### Phase Transition Bug

Check `app/rules/fsm.py` and `phase_machine.py`:

```python
# Common issue: Wrong attribute name
# BUG
if hasattr(region, "positions"):  # Wrong!

# FIX
if hasattr(region, "spaces"):     # Correct!
```

#### Board State Divergence

Check `app/rules/board_manager.py`:

```python
# Common issue: Different iteration order
# BUG - Dict iteration may differ
for pos, marker in markers.items():

# FIX - Sort for deterministic order
for pos in sorted(markers.keys(), key=lambda p: (p.x, p.y, p.z)):
    marker = markers[pos]
```

#### ANM Detection

Check `app/rules/anm_detection.py`:

```python
# Common issue: Different line detection
# Ensure hex direction vectors match TypeScript
HEX_DIRECTIONS = [
    (1, 0, -1), (-1, 0, 1),   # axial
    (0, 1, -1), (0, -1, 1),   # axial
    (1, -1, 0), (-1, 1, 0),   # axial
]
```

### 4.5 Validate Fix

```bash
# Re-run parity validation
python scripts/check_ts_python_replay_parity.py \
  --db data/games/my_games.db \
  --fail-fast

# Run full parity test suite
pytest tests/parity/ -v

# Generate fresh games with validation
python scripts/generate_gumbel_selfplay.py \
  --board hex8 \
  --games 100 \
  --validate-parity \
  --fail-fast
```

---

## 5. Prevention

### 5.1 Pre-Training Parity Gate

Always run parity validation before training:

```bash
# Parity gate script
python scripts/run_canonical_selfplay_parity_gate.py \
  --board-type hex8 \
  --games 100 \
  --fail-threshold 0  # Zero tolerance
```

### 5.2 CI/CD Parity Tests

Ensure parity tests run on every PR:

```yaml
# .github/workflows/parity.yml
- name: Run Parity Tests
  run: |
    cd ai-service
    pytest tests/parity/ -v --tb=short
```

### 5.3 Monitor Parity Metrics

Track parity pass rate in Prometheus:

```python
# In parity validation code
from prometheus_client import Counter, Gauge

parity_checks = Counter('parity_checks_total', 'Total parity checks', ['board_type', 'result'])
parity_pass_rate = Gauge('parity_pass_rate', 'Parity pass rate', ['board_type'])
```

### 5.4 TypeScript Rules Update Protocol

When TypeScript rules change:

1. Review `src/shared/engine/` changes
2. Update corresponding Python in `app/rules/`
3. Run full parity validation
4. Update parity test fixtures if needed

---

## 6. Escalation

### 6.1 When to Escalate

- Parity failures persist after fixes
- Root cause unclear after investigation
- Multiple board types affected
- Regression in previously working code

### 6.2 Information to Gather

1. Game ID and divergence move number
2. Mismatch type (phase, board, scores, etc.)
3. State bundle JSON files
4. Diff output showing exact divergence
5. Recent changes to rules code

### 6.3 Escalation Path

1. Check if TypeScript rules changed recently
2. Review Git history for both Python and TypeScript
3. Create minimal reproduction case
4. File issue with state bundles attached

---

## 7. Related Alerts

- `TrainingDataCorrupted` - May be caused by parity issues
- `ModelAccuracyDrop` - Can result from training on bad data
- `SelfplayValidationFailed` - Direct parity failure

---

## 8. Quick Reference

```bash
# Quick parity check
python scripts/check_ts_python_replay_parity.py \
  --db data/games/canonical_hex8_2p.db

# Debug specific game
RINGRIFT_TRACE_DEBUG=1 \
RINGRIFT_TS_REPLAY_DUMP_STATE_AT_K=<move> \
RINGRIFT_TS_REPLAY_DUMP_DIR=/tmp/debug \
python scripts/selfplay-db-ts-replay.py \
  --db <db_path> --game <game_id>

# Diff states
python scripts/diff_state_bundle.py \
  --bundle /tmp/debug/<game_id>.state_bundle.json \
  --k <move>

# Full parity test suite
pytest tests/parity/ -v
```

---

## 9. Known Parity Issues

### Resolved

| Issue         | Root Cause                  | Fix                            | Date       |
| ------------- | --------------------------- | ------------------------------ | ---------- |
| HEX-PARITY-01 | Wrong attribute name in FSM | Use `.spaces` not `.positions` | 2025-12-21 |

### Open

See `docs/runbooks/HEXAGONAL_PARITY_BUG.md` for any open parity investigations.

---

**Last Updated:** December 2025
