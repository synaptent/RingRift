name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'ai-service/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'ai-service/**'

defaults:
  run:
    working-directory: ai-service

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ai-service/requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install ruff mypy

      - name: Run Ruff linter
        run: ruff check . --output-format=github

      - name: Run Ruff formatter check
        run: ruff format --check .

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          pip install bandit safety

      - name: Run Bandit security linter
        run: |
          bandit -r app/ -ll -ii --format txt --output bandit-report.txt || true
          cat bandit-report.txt
          # Fail on high severity issues
          bandit -r app/ -ll -ii --format json | python -c "
          import json, sys
          data = json.load(sys.stdin)
          high_issues = [r for r in data.get('results', []) if r['issue_severity'] == 'HIGH']
          if high_issues:
              print(f'Found {len(high_issues)} HIGH severity issues')
              for issue in high_issues:
                  print(f\"  - {issue['filename']}:{issue['line_number']}: {issue['issue_text']}\")
              sys.exit(1)
          print('No HIGH severity issues found')
          "

      - name: Check dependencies for vulnerabilities
        run: |
          # Check for known vulnerabilities in dependencies
          safety check -r requirements.txt --output text || echo "::warning::Some dependencies have known vulnerabilities"

  dead-code-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install vulture
        run: pip install vulture

      - name: Check for dead code (100% confidence)
        run: |
          # Run vulture with 100% confidence to catch definite dead code
          # Excludes the intentional return-before-yield pattern in generators
          vulture app/ scripts/ --min-confidence 100 \
            --exclude "game_record_loader.py" \
            2>&1 | tee vulture_output.txt
          # Fail if any dead code found (excluding the known generator pattern)
          if grep -q "unused" vulture_output.txt; then
            echo "Dead code detected! Please remove unused code or prefix with underscore."
            exit 1
          fi
          echo "No dead code found."

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ai-service/requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install mypy types-PyYAML types-requests

      - name: Run mypy
        run: mypy app --ignore-missing-imports --no-error-summary || true

  architecture-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ai-service/requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install import-linter

      - name: Check architecture constraints
        run: |
          echo "Checking architecture constraints..."
          lint-imports || echo "::warning::Architecture constraint violations detected"

  deprecation-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for deprecated module usage
        run: |
          echo "Checking for deprecated module usage..."
          # Fail if any script imports deprecated modules without being the deprecated file itself
          DEPRECATED_IMPORTS=$(grep -r "from scripts.simple_game_sync import\|from scripts.model_sync_aria2 import\|from scripts.baseline_gauntlet import\|from scripts.run_vast_gauntlet import" scripts/ --include="*.py" 2>/dev/null | grep -v "^scripts/simple_game_sync.py\|^scripts/model_sync_aria2.py\|^scripts/baseline_gauntlet.py\|^scripts/run_vast_gauntlet.py" || true)
          if [ -n "$DEPRECATED_IMPORTS" ]; then
            echo "ERROR: Found imports from deprecated modules:"
            echo "$DEPRECATED_IMPORTS"
            echo ""
            echo "Please use the canonical alternatives:"
            echo "  - simple_game_sync.py -> unified_data_sync.py"
            echo "  - model_sync_aria2.py -> sync_models.py"
            echo "  - baseline_gauntlet.py -> run_gauntlet.py"
            echo "  - run_vast_gauntlet.py -> run_gauntlet.py"
            exit 1
          fi
          echo "No deprecated module imports found."

  test-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ai-service/requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-timeout

      - name: Run unit tests
        env:
          RINGRIFT_SKIP_SHADOW_CONTRACTS: 'false'
        run: |
          pytest tests/unit/ -v --tb=short \
            --cov=app --cov-report=xml --cov-report=term-missing \
            --cov-fail-under=45 \
            -x --timeout=60

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./ai-service/coverage.xml
          fail_ci_if_error: false

  test-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ai-service/requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-timeout

      - name: Run integration tests
        env:
          RINGRIFT_SKIP_SHADOW_CONTRACTS: 'false'
        run: |
          pytest tests/integration/ -v --tb=short \
            --ignore=tests/test_training_integration.py \
            --ignore=tests/test_distributed_training.py \
            -x --timeout=120

  test-legacy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ai-service/requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-timeout

      - name: Run legacy tests
        env:
          RINGRIFT_SKIP_SHADOW_CONTRACTS: 'false'
        run: |
          pytest tests/ -v --tb=short \
            --ignore=tests/unit/ \
            --ignore=tests/integration/ \
            --ignore=tests/benchmarks/ \
            --ignore=tests/test_training_integration.py \
            --ignore=tests/test_distributed_training.py \
            -x --timeout=60

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./ai-service
          push: false
          tags: ringrift-ai-service:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  mutation-testing:
    runs-on: ubuntu-latest
    # Only run on main branch to save CI time
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ai-service/requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-timeout mutmut

      - name: Run mutation testing on critical modules
        run: |
          # Run mutation testing on small, critical modules
          # This validates that our tests actually catch bugs
          mutmut run \
            --paths-to-mutate=app/ai/neural_losses.py \
            --tests-dir=tests/ \
            --runner="python -m pytest tests/unit/ai/test_neural_losses.py -x -q --tb=no" \
            --no-progress || true

          # Report results
          echo "=== Mutation Testing Results ==="
          mutmut results

          # Check survival rate (warn if >30% survive)
          SURVIVED=$(mutmut results 2>/dev/null | grep -oP 'Survived: \K\d+' || echo "0")
          TOTAL=$(mutmut results 2>/dev/null | grep -oP 'Total: \K\d+' || echo "1")
          if [ "$TOTAL" -gt 0 ]; then
            RATE=$((SURVIVED * 100 / TOTAL))
            echo "Mutation survival rate: ${RATE}%"
            if [ "$RATE" -gt 30 ]; then
              echo "::warning::High mutation survival rate (${RATE}%) - consider adding more thorough tests"
            fi
          fi

  gpu-smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ai-service/requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-timeout

      - name: Verify GPU module imports
        run: |
          python -c "
          # Core GPU modules
          from app.ai.gpu_batch_state import BatchGameState
          from app.ai.gpu_game_types import MoveType, GameStatus
          from app.ai.gpu_parallel_games import ParallelGameRunner
          from app.ai.gpu_heuristic import evaluate_positions_batch
          from app.ai.gpu_move_generation import generate_all_moves_batch
          from app.ai.gpu_line_detection import detect_lines_vectorized
          from app.ai.gpu_move_application import apply_placement_moves_batch
          print('All GPU module imports OK')
          "

      - name: Test BatchGameState creation (CPU mode)
        run: |
          python -c "
          import torch
          from app.ai.gpu_batch_state import BatchGameState

          # Create batch state on CPU
          state = BatchGameState.create_batch(
              batch_size=4,
              board_size=8,
              num_players=2,
              device=torch.device('cpu')
          )
          assert state.batch_size == 4
          assert state.board_size == 8
          assert state.num_players == 2
          print(f'BatchGameState created: {state.batch_size} games on {state.device}')
          "

      - name: Run GPU parity tests (CPU mode)
        run: |
          # Run GPU parity tests which verify GPU code matches CPU semantics
          pytest tests/gpu/test_gpu_cpu_parity.py -v --tb=short -x --timeout=60

  sanity-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'ai-service/requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify imports
        run: |
          python -c "from app.main import app; print('FastAPI app OK')"
          python -c "from app.ai.heuristic_ai import HeuristicAI; print('HeuristicAI OK')"
          python -c "from app.ai.nnue import NNUEEvaluator; print('NNUE OK')"

      - name: Check model loading
        run: |
          python -c "
          from app.ai.nnue_policy import NNUEPolicyNet
          model = NNUEPolicyNet(board_type='square8', num_players=2)
          print(f'Model params: {sum(p.numel() for p in model.parameters()):,}')
          "
