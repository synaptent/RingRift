# RingRift Cluster Configuration
# Updated: 2025-12-26
# Providers: vast.ai, runpod, vultr, nebius, hetzner, local
#
# Lambda Labs account terminated Dec 2025. All Lambda nodes permanently removed.

sync_routing:
  # Dec 2025: max triggers cleanup, target is where we clean to (10% gap)
  max_disk_usage_percent: 70
  target_disk_usage_percent: 60
  min_free_disk_percent: 15
  replication_target: 2
  # Dec 2025: Removed mac-studio from excluded_hosts - use allowed_external_storage instead
  # This fixes the contradiction where mac-studio was both excluded and allowed
  excluded_hosts: []
  # OWC external drive mounted as /Volumes/RingRift-Data on mac-studio
  allowed_external_storage:
  - host: mac-studio
    path: /Volumes/RingRift-Data
    receive_games: true
    receive_npz: true
    receive_models: true
    subdirs:
      # Dec 27, 2025: Aligned with mac-studio.storage_paths for consistency
      games: selfplay_repository
      npz: canonical_data
      models: canonical_models
  # Dec 2025: Priority hosts for data distribution (receive data first)
  # These training nodes have high capacity or currently lack data
  priority_hosts:
    - runpod-a100-1          # 0 games - urgent need for training data
    - runpod-a100-storage-1  # 500GB volume for large datasets
    - nebius-h100-3          # Primary training node, 452GB storage
    - nebius-h100-1          # Secondary training node
  # Underserved configs that need more selfplay data generation
  underserved_configs:
    - square19_4p    # 0 games in canonical
    - hexagonal_3p   # 0 games in canonical
    - hexagonal_4p   # 3 games in canonical
    - square19_3p    # 150 games
    - square19_2p    # 77 games

auto_sync:
  enabled: true
  # Dec 2025: Reduced from 300s to 60s for fresher training data
  # This is a Phase 1 quick win for 2000+ Elo
  interval_seconds: 60
  # Dec 2025: Reduced from 60s to 15s for faster gossip propagation
  gossip_interval_seconds: 15
  skip_nfs_sync: true
  # Dec 2025: Increased to 12 for faster gossip propagation across 31-node cluster
  # With 12 concurrent syncs, data reaches all nodes in ~3 rounds vs ~5 rounds with 8
  max_concurrent_syncs: 12
  min_games_to_sync: 10
  bandwidth_limit_mbps: 100
  # Dec 2025: Removed mac-studio from exclude_hosts to enable coordinator backup
  # Coordinator receives data via allowed_external_storage (/Volumes/RingRift-Data)
  # This prevents data loss if all GPU nodes fail
  exclude_hosts: []
  host_bandwidth_overrides:
    vast-*: 50
    runpod-*: 100
    nebius-*: 100
    vultr-*: 50

elo_sync:
  coordinator: mac-studio
  sync_port: 8766
  sync_interval: 300
  divergence_threshold: 50
  transports:
  - tailscale
  - aria2
  - http

# P2P voter configuration - stable nodes for leader election
# Quorum requires 3 voters (majority of 5).
#
# IMPORTANT: This list is the single source of truth for voter nodes.
# Do NOT set p2p_voter: true on individual nodes - it will be ignored.
# The p2p_voters list below is the authoritative voter configuration.
#
# Dec 27, 2025: Fixed voters - only nodes with nat_blocked=false
# Previous config had mac-studio (NAT blocked), vast-29129529 (retired)
# Selecting nodes that are: online, not NAT blocked, not retired
# With 5 voters, quorum = 3 (majority)
# Dec 26, 2025: Removed aws-staging (undefined host), added vultr-a100-20gb
# Dec 27, 2025: Replaced runpod-h100 (containerized) with hetzner-cpu2 (bare metal)
#   P2P voters should be non-containerized for stability during leader elections
p2p_voters:
  - nebius-backbone-1 # Nebius L40S - stable, bare metal, direct IP
  - nebius-h100-3     # Nebius H100 - stable, bare metal, direct IP
  - hetzner-cpu1      # Hetzner CPU - stable, bare metal, direct IP
  - hetzner-cpu2      # Hetzner CPU - stable, bare metal, direct IP (backup)
  - vultr-a100-20gb   # Vultr A100 - stable, VM, direct IP

hosts:
  # ============================================================
  # LOCAL / COORDINATOR
  # ============================================================
  mac-studio:
    ssh_host: 100.107.168.125
    ssh_user: armand
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/Development/RingRift/ai-service
    venv_activate: source ~/Development/RingRift/ai-service/venv/bin/activate
    memory_gb: 96
    cpus: 14
    gpu: M3 Max/Ultra (MPS)
    gpu_vram_gb: 64
    role: coordinator
    status: ready
    selfplay_enabled: false
    training_enabled: false
    p2p_enabled: true
    # Dec 2025: Route ALL data to OWC external drive (7.3TB) to prevent SSD fill-up
    # This is the canonical backup location for the entire RingRift cluster
    storage_paths:
      games: /Volumes/RingRift-Data/selfplay_repository
      models: /Volumes/RingRift-Data/canonical_models
      training_data: /Volumes/RingRift-Data/canonical_data
      checkpoints: /Volumes/RingRift-Data/model_checkpoints
      logs: /Volumes/RingRift-Data/logs
      # Keep cluster_games separate for raw incoming syncs
      sync_incoming: /Volumes/RingRift-Data/cluster_games
    # Prevent any data accumulation on SSD by routing all sync targets to OWC
    use_external_storage: true
    external_storage_path: /Volumes/RingRift-Data

  # Dec 26, 2025: Added local-mac as coordinator-only (MacBook Pro)
  # This prevents local machine from being assigned training/selfplay tasks
  # Dec 27, 2025: Added skip_sync_receive to prevent data accumulation
  local-mac:
    ssh_host: localhost
    ssh_user: armand
    ringrift_path: /Users/armand/Development/RingRift/ai-service
    memory_gb: 36
    cpus: 10
    gpu: none
    role: coordinator
    status: ready
    selfplay_enabled: false
    training_enabled: false
    gauntlet_enabled: false
    export_enabled: false
    # Dec 2025: Prevent any data accumulation on MacBook
    # All data should go to Mac Studio OWC drive, not this laptop
    skip_sync_receive: true
    sync_to_mac_studio_owc: true
    # Coordinator-only: keep P2P disabled to avoid local deployment.
    p2p_enabled: false

  # ============================================================
  # VAST.AI NODES (12 running)
  # ============================================================

  # --- TIER 1: Multi-GPU (Best for parallel selfplay) ---
  vast-29129529:
    ssh_host: ssh6.vast.ai
    ssh_port: 19528
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 515
    cpus: 128
    gpu: 8x RTX 4090
    gpu_vram_gb: 192
    role: gpu_selfplay_primary
    status: ready
    vast_instance_id: '29129529'
    p2p_enabled: true

  vast-29118471:
    ssh_host: ssh8.vast.ai
    ssh_port: 38470
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 1007
    cpus: 192
    gpu: 8x RTX 3090
    gpu_vram_gb: 192
    role: gpu_selfplay_primary
    status: ready
    vast_instance_id: '29118471'
    p2p_enabled: true

  vast-29128352:
    ssh_host: ssh9.vast.ai
    ssh_port: 18352
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: /workspace/ringrift/ai-service
    venv_activate: ":"
    memory_gb: 645
    cpus: 384
    gpu: 2x RTX 5090
    gpu_vram_gb: 64
    role: nn_training_primary
    status: ready
    vast_instance_id: '29128352'
    p2p_enabled: true

  # --- TIER 2: High-end single GPU ---
  vast-28925166:
    ssh_host: ssh1.vast.ai
    ssh_port: 15166
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 440
    cpus: 192
    gpu: RTX 5090
    gpu_vram_gb: 32
    role: nn_training_primary
    status: ready
    vast_instance_id: '28925166'
    p2p_enabled: true

  vast-29128356:
    ssh_host: ssh7.vast.ai
    ssh_port: 18356
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: /workspace/ringrift/ai-service
    venv_activate: source /workspace/ringrift/ai-service/venv/bin/activate
    memory_gb: 440
    cpus: 192
    gpu: RTX 5090
    gpu_vram_gb: 32
    role: nn_training_primary
    status: ready
    vast_instance_id: '29128356'
    p2p_enabled: true

  vast-28918742:
    ssh_host: ssh8.vast.ai
    ssh_port: 38742
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 128
    cpus: 32
    gpu: A40
    gpu_vram_gb: 46
    role: gpu_selfplay
    status: ready
    vast_instance_id: '28918742'
    p2p_enabled: true

  vast-29031159:
    ssh_host: ssh5.vast.ai
    ssh_port: 31158
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 440
    cpus: 64
    gpu: RTX 5080
    gpu_vram_gb: 16
    role: gpu_selfplay
    status: ready
    vast_instance_id: '29031159'
    p2p_enabled: true

  # --- TIER 3: Mid-range GPUs ---
  vast-29126088:
    ssh_host: ssh5.vast.ai
    ssh_port: 16088
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: /workspace/ringrift/ai-service
    venv_activate: source /workspace/ringrift/ai-service/venv/bin/activate
    memory_gb: 125
    cpus: 24
    gpu: RTX 4060 Ti
    gpu_vram_gb: 16
    role: gpu_selfplay
    status: ready
    vast_instance_id: '29126088'
    p2p_enabled: true

  vast-29031161:
    ssh_host: ssh2.vast.ai
    ssh_port: 31160
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 64
    cpus: 16
    gpu: RTX 3060
    gpu_vram_gb: 12
    role: gpu_selfplay
    status: ready
    vast_instance_id: '29031161'
    p2p_enabled: true

  vast-28890015:
    ssh_host: ssh9.vast.ai
    ssh_port: 10014
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 64
    cpus: 16
    gpu: RTX 2080 Ti
    gpu_vram_gb: 11
    role: gpu_selfplay
    status: ready
    vast_instance_id: '28890015'
    p2p_enabled: true

  # --- TIER 4: Entry-level GPUs ---
  vast-28889766:
    ssh_host: ssh3.vast.ai
    ssh_port: 19766
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 32
    cpus: 8
    gpu: RTX 3060 Ti
    gpu_vram_gb: 8
    role: gpu_selfplay
    status: ready
    vast_instance_id: '28889766'
    p2p_enabled: true

  vast-29046315:
    ssh_host: ssh2.vast.ai
    ssh_port: 16314
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 251
    cpus: 48
    gpu: RTX 3060 Ti
    gpu_vram_gb: 8
    role: gpu_selfplay
    status: ready
    vast_instance_id: '29046315'
    p2p_enabled: true

  # NEW: RTX 5090 nodes discovered Dec 26 (not in original config)
  vast-29118472:
    ssh_host: ssh9.vast.ai
    ssh_port: 38472
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 440
    cpus: 192
    gpu: RTX 5090
    gpu_vram_gb: 32
    role: gpu_selfplay
    status: ready
    vast_instance_id: '29118472'
    p2p_enabled: true

  vast-29129151:
    ssh_host: ssh4.vast.ai
    ssh_port: 19150
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 440
    cpus: 192
    gpu: RTX 5090
    gpu_vram_gb: 32
    role: gpu_selfplay
    status: ready
    vast_instance_id: '29129151'
    p2p_enabled: true

  # ============================================================
  # RUNPOD NODES (7 running)
  # ============================================================
  runpod-h100:
    ssh_host: 102.210.171.65
    ssh_port: 30755
    ssh_user: root
    ssh_key: ~/.runpod/ssh/RunPod-Key-Go
    ringrift_path: /workspace/ringrift/ai-service
    venv_activate: source /workspace/ringrift/ai-service/venv/bin/activate
    memory_gb: 80
    cpus: 24
    gpu: H100 PCIe
    gpu_vram_gb: 80
    role: gpu_selfplay_primary
    status: ready
    runpod_id: g47o0nibwifwzw
    p2p_enabled: true

  runpod-a100-1:
    ssh_host: 38.128.233.145
    ssh_port: 33085
    ssh_user: root
    ssh_key: ~/.runpod/ssh/RunPod-Key-Go
    ringrift_path: /workspace/ringrift/ai-service
    venv_activate: source /workspace/ringrift/ai-service/venv/bin/activate
    memory_gb: 80
    cpus: 24
    gpu: A100 PCIe
    gpu_vram_gb: 80
    role: gpu_selfplay
    status: ready
    runpod_id: hl2rzjdfdrtath
    p2p_enabled: true

  runpod-a100-2:
    ssh_host: 104.255.9.187
    ssh_port: 11681
    ssh_user: root
    ssh_key: ~/.runpod/ssh/RunPod-Key-Go
    ringrift_path: /workspace/ringrift/ai-service
    venv_activate: source /workspace/ringrift/ai-service/venv/bin/activate
    memory_gb: 80
    cpus: 24
    gpu: A100 PCIe
    gpu_vram_gb: 80
    role: gpu_selfplay
    status: ready
    runpod_id: yu03gfn71vrsj7
    p2p_enabled: true

  # New RunPod A100 provisioned Dec 26, 2025 (500GB storage)
  runpod-a100-storage-1:
    ssh_host: 213.173.105.7
    ssh_port: 30015
    ssh_user: root
    ssh_key: ~/.runpod/ssh/RunPod-Key-Go
    ringrift_path: /workspace/ringrift/ai-service
    venv_activate: source /workspace/ringrift/ai-service/venv/bin/activate
    memory_gb: 80
    cpus: 24
    gpu: A100 PCIe
    gpu_vram_gb: 80
    role: gpu_selfplay
    status: ready
    runpod_id: a0h3cf7yg1duiv
    p2p_enabled: true
    note: A100 80GB with 500GB volume storage

  runpod-l40s-2:
    ssh_host: 193.183.22.62
    ssh_port: 1182
    ssh_user: root
    ssh_key: ~/.runpod/ssh/RunPod-Key-Go
    ringrift_path: /workspace/ringrift/ai-service
    venv_activate: source /workspace/ringrift/ai-service/venv/bin/activate
    memory_gb: 48
    cpus: 24
    gpu: L40S
    gpu_vram_gb: 48
    role: gpu_selfplay
    status: ready
    runpod_id: 3y9qgdj3lkjj6r
    p2p_enabled: true

  runpod-3090ti-1:
    ssh_host: 174.94.157.109
    ssh_port: 29473
    ssh_user: root
    ssh_key: ~/.runpod/ssh/RunPod-Key-Go
    ringrift_path: /root/ringrift/ai-service
    venv_activate: source /root/ringrift/ai-service/venv/bin/activate
    memory_gb: 24
    cpus: 32
    gpu: RTX 3090 Ti
    gpu_vram_gb: 24
    role: gpu_selfplay
    status: ready
    runpod_id: dqc6nvrwig8ajq
    p2p_enabled: true

  # ============================================================
  # VULTR NODES (1 running)
  # ============================================================
  vultr-a100-20gb:
    ssh_host: 208.167.249.164
    ssh_port: 22
    ssh_user: root
    ssh_key: ~/.ssh/id_ed25519
    ringrift_path: /root/ringrift/ai-service
    venv_activate: source /root/ringrift/ai-service/venv/bin/activate
    memory_gb: 30
    cpus: 3
    gpu: A100D-20C (vGPU)
    gpu_vram_gb: 20
    role: gpu_selfplay
    status: ready
    vultr_id: 016fe347-d10d-4348-90f6-e3ad9943246a
    region: ewr
    p2p_enabled: true

  # New Vultr A100 provisioned Dec 26, 2025
  vultr-a100-20gb-2:
    ssh_host: 140.82.15.69
    ssh_port: 22
    ssh_user: root
    ssh_key: ~/.ssh/id_ed25519
    ringrift_path: /root/ringrift/ai-service
    venv_activate: source /root/ringrift/ai-service/venv/bin/activate
    memory_gb: 30
    cpus: 3
    gpu: A100D-20C (vGPU)
    gpu_vram_gb: 20
    role: gpu_selfplay
    status: ready
    vultr_id: 7d37247e-37ab-4d21-9eeb-ce082ebad05a
    region: ewr
    p2p_enabled: true

  # ============================================================
  # NEBIUS NODES (2 running)
  # ============================================================
  nebius-backbone-1:
    ssh_host: 89.169.112.47
    ssh_port: 22
    ssh_user: ubuntu
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 32
    cpus: 8
    gpu: L40S
    gpu_vram_gb: 48
    role: backbone
    status: ready
    nebius_id: computeinstance-e00gyg7x6xhkc7fs5x
    region: eu-north1
    p2p_enabled: true
    note: P2P backbone node for stable connectivity

  # New Nebius H100 provisioned Dec 26, 2025 (80GB VRAM!)
  nebius-h100-1:
    ssh_host: 89.169.111.139
    ssh_port: 22
    ssh_user: ubuntu
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 200
    cpus: 16
    gpu: H100 SXM
    gpu_vram_gb: 80
    role: gpu_training_primary
    status: ready
    nebius_id: computeinstance-e00y1q84pxfs1s3jqb
    region: eu-north1
    p2p_enabled: true
    note: H100 80GB for training

  # Nebius H100 #2 - Internal IP only, requires ProxyJump through nebius-backbone-1
  # Provisioned Dec 26, 2025
  # SSH Config needed: Host nebius-h100-2
  #                      ProxyJump nebius-backbone-1
  nebius-h100-2:
    ssh_host: 10.0.0.8
    ssh_port: 22
    ssh_user: ubuntu
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 200
    cpus: 16
    gpu: H100 SXM
    gpu_vram_gb: 80
    role: gpu_training_primary
    status: retired  # Dec 27, 2025: Unreachable via ProxyJump, no public IP
    nebius_id: computeinstance-e00xsba9efvkpvk8wy
    region: eu-north1
    p2p_enabled: false
    note: H100 80GB - RETIRED Dec 27 2025 (internal IP only, ProxyJump fails)

  # Nebius H100 #3 - 500GB storage, H100 80GB
  # Provisioned Dec 26, 2025 to replace deleted nodes
  nebius-h100-3:
    ssh_host: 89.169.110.128
    ssh_port: 22
    ssh_user: ubuntu
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: ~/ringrift/ai-service
    venv_activate: source ~/ringrift/ai-service/venv/bin/activate
    memory_gb: 200
    cpus: 16
    gpu: H100 SXM
    gpu_vram_gb: 80
    role: gpu_training_primary
    status: ready
    nebius_id: computeinstance-e00hcbnn7s7p0c7bbp
    region: eu-north1
    p2p_enabled: true
    note: H100 80GB with 500GB storage, P2P voter

  # ============================================================
  # AWS NODES (proxy only, no GPU)
  # ============================================================
  # AWS proxy node - t3.micro for SSH tunneling to internal cloud networks
  # NOTE: This is a proxy-only node without RingRift codebase (too small at 1GB RAM)
  aws-proxy:
    ssh_host: 3.147.65.95
    ssh_port: 22
    ssh_user: ec2-user
    ssh_key: ~/.ssh/ringrift-proxy-key.pem
    ringrift_path: null  # No codebase on proxy node
    memory_gb: 1
    cpus: 2
    role: proxy
    status: proxy_only  # Skip in update scripts
    aws_instance_id: i-07435e263bca683e0
    selfplay_enabled: false
    training_enabled: false
    p2p_enabled: false

  # ============================================================
  # HETZNER NODES (3 running - CPU only)
  # ============================================================
  hetzner-cpu1:
    ssh_host: 46.62.147.150
    ssh_port: 22
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: /root/ringrift/ai-service
    venv_activate: source /root/ringrift/ai-service/venv/bin/activate
    memory_gb: 16
    cpus: 8
    role: cpu_selfplay
    status: ready
    hetzner_id: ringrift-cpu1
    region: eu-central
    p2p_enabled: true
    note: CPU-only node for heuristic selfplay

  hetzner-cpu2:
    ssh_host: 135.181.39.239
    ssh_port: 22
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: /root/ringrift/ai-service
    venv_activate: source /root/ringrift/ai-service/venv/bin/activate
    memory_gb: 32
    cpus: 16
    role: cpu_selfplay
    status: ready
    hetzner_id: ringrift-cpu2
    region: eu-central
    p2p_enabled: true
    note: CPU-only node for heuristic selfplay

  hetzner-cpu3:
    ssh_host: 46.62.217.168
    ssh_port: 22
    ssh_user: root
    ssh_key: ~/.ssh/id_cluster
    ringrift_path: /root/ringrift/ai-service
    venv_activate: source /root/ringrift/ai-service/venv/bin/activate
    memory_gb: 32
    cpus: 16
    role: cpu_selfplay
    status: ready
    hetzner_id: ringrift-cpu3
    region: eu-central
    p2p_enabled: true
    note: CPU-only node for heuristic selfplay
