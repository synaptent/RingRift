# Nginx configuration for cluster.ringrift.ai
# This config is for the AWS EC2 proxy instance that routes traffic
# to the current P2P cluster leader via Tailscale.
#
# REQUIREMENTS:
# - Tailscale installed and authenticated on the proxy instance
# - Route 53 RINGRIFT_ROUTE53_ZONE_ID set on cluster nodes
# - SSL certificate for cluster.ringrift.ai (use certbot)
#
# DEPLOYMENT:
# 1. Install on AWS EC2 instance with public IP
# 2. Copy this to /etc/nginx/sites-available/cluster.ringrift.ai
# 3. ln -s /etc/nginx/sites-available/cluster.ringrift.ai /etc/nginx/sites-enabled/
# 4. sudo nginx -t && sudo systemctl reload nginx

# Upstream to cluster leader (dynamically resolved via DNS or discovery endpoint)
# The Route 53 DNS (cluster.ringrift.ai) points directly to the leader's Tailscale IP
# so Nginx just needs to forward to that resolved address.

upstream cluster_backend {
    # The leader's Tailscale IP - resolved dynamically via Route 53
    # When a new leader is elected, it updates Route 53 with its Tailscale IP
    server cluster-leader.internal:8770;

    # Health check settings
    keepalive 32;
}

# Alternative: Use resolver for dynamic DNS resolution
# (Uncomment if you want Nginx to re-resolve DNS on each request)
# resolver 8.8.8.8 valid=30s;

server {
    listen 80;
    server_name cluster.ringrift.ai;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name cluster.ringrift.ai;

    # SSL certificates (managed by certbot)
    ssl_certificate /etc/letsencrypt/live/cluster.ringrift.ai/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cluster.ringrift.ai/privkey.pem;

    # SSL settings
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    # Modern SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;

    # Logging
    access_log /var/log/nginx/cluster.ringrift.ai.access.log;
    error_log /var/log/nginx/cluster.ringrift.ai.error.log;

    # Main dashboard location
    location / {
        # Use resolver for dynamic IP resolution based on Route 53 DNS
        resolver 8.8.8.8 valid=10s;
        set $backend "http://cluster.ringrift.ai:8770";

        proxy_pass $backend;
        proxy_http_version 1.1;

        # Required headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (for future dashboard features)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering settings for dashboard responsiveness
        proxy_buffering off;
        proxy_buffer_size 4k;
    }

    # API endpoints
    location /api/ {
        resolver 8.8.8.8 valid=10s;
        set $backend "http://cluster.ringrift.ai:8770";

        proxy_pass $backend;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Longer timeout for API calls (some may be heavy)
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # Leader discovery endpoint (Failover Option 3)
    # This endpoint always returns info about the current leader
    # Can be used by external services to find the leader
    location = /api/leader {
        resolver 8.8.8.8 valid=10s;
        set $backend "http://cluster.ringrift.ai:8770";

        proxy_pass $backend;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Quick response expected
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # Health check endpoint
    location = /health {
        resolver 8.8.8.8 valid=10s;
        set $backend "http://cluster.ringrift.ai:8770";

        proxy_pass $backend;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # Quick health checks
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Status page (simple text response for uptime monitoring)
    location = /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 10.0.0.0/8;      # AWS internal
        allow 100.64.0.0/10;   # Tailscale CGNAT range
        deny all;
    }
}
