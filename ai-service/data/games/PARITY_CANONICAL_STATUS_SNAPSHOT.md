# Parity & Canonical Replay Status Snapshot

_Updated via P2c.1 on 2025-12-09 after FSM alignment and DB writer changes. This is a diagnostic run only; no code, configs, or DB data were modified._

## Scope

This snapshot covers square8 replay databases referenced (directly or indirectly) in [`TRAINING_DATA_REGISTRY.md`](ai-service/TRAINING_DATA_REGISTRY.md:1) and closely related self-play/victory-study DBs discovered under [`ai-service/data/games/`](ai-service/data/games:1). Non-square8 entries (square19/hex) are included only as carry-over context from earlier snapshots and were **not** re-gated in P2c.1.

Databases included (square8-focused P2c.1 run):

- [`canonical_square8.db`](ai-service/data/games/canonical_square8.db:1)
- [`selfplay.db`](ai-service/data/games/selfplay.db:1)
- [`selfplay_square8_2p.db`](ai-service/data/games/selfplay_square8_2p.db:1)
- [`selfplay_square8_3p.db`](ai-service/data/games/selfplay_square8_3p.db:1)
- [`selfplay_square8_4p.db`](ai-service/data/games/selfplay_square8_4p.db:1)
- [`debug_square8.db`](ai-service/data/games/debug_square8.db:1)
- [`square8_2p.db`](ai-service/data/games/square8_2p.db:1)
- [`square8_3p.db`](ai-service/data/games/square8_3p.db:1)
- [`square8_4p.db`](ai-service/data/games/square8_4p.db:1)
- [`victory_study/square8_2p.db`](ai-service/data/games/victory_study/square8_2p.db:1)
- [`victory_study/square8_3p.db`](ai-service/data/games/victory_study/square8_3p.db:1)
- [`victory_study/square8_4p.db`](ai-service/data/games/victory_study/square8_4p.db:1)
- Virtual/absent registry entries (not re-gated in P2c.1):
  - `canonical_square19.db` (referenced in registry notes, not present on disk)
  - `canonical_hex.db` (explicitly removed per registry/model docs)
  - `selfplay_aws.db` (legacy square8 self-play DB, no longer present locally)

All P2c.1 checks for square8 DBs were run via the existing parity/canonical-history tooling:

- [`run_parity_and_history_gate.py`](ai-service/scripts/run_parity_and_history_gate.py:1)  
  (wrapper over [`check_ts_python_replay_parity.py`](ai-service/scripts/check_ts_python_replay_parity.py:1) and [`check_canonical_phase_history.py`](ai-service/scripts/check_canonical_phase_history.py:1))

Commands were executed from the repo root with `PYTHONPATH=ai-service`.

## Database Status Table

Legend:

- **Parity status**:
  - `pass` = parity script completed with **no structural issues and no semantic divergences** (end-of-game-only divergences allowed).
  - `fail` = any structural issues or semantic divergences.
  - `not_checked` = DB not present locally or not re-run in P2c.1.
- **Canonical-history status**: `pass` = [`check_canonical_phase_history.py`](ai-service/scripts/check_canonical_phase_history.py:1) exited 0; `fail` = non-zero (phase/move invariant violations).
- **Classification**:
  - `canonical` = parity **and** canonical-history passed for all checked games (or DB is empty).
  - `legacy_noncanonical` = canonical-history failed (structural / recording issues).
  - `parity_divergent` = canonical-history passed, but TS↔Python semantics still diverge.

| DB                              | Path                                                                                                       | Board / Players                               | Declared Status (Registry)                      | Parity Status (P2c.1)                                                                                                                                          | Canonical-History Status (P2c.1)                                                                                                                                                                    | Classification        | Notes / Gate Artifacts                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ------------------------------- | ---------------------------------------------------------------------------------------------------------- | --------------------------------------------- | ----------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `canonical_square8.db`          | [`ai-service/data/games/canonical_square8.db`](ai-service/data/games/canonical_square8.db:1)               | square8 / 2p (currently **14 games**)         | **pending_gate** (registry row)                 | **fail** – `games_with_semantic_divergence = 0`, `games_with_structural_issues = 14`, `total_games_checked = 14` (see `canonical_square8.db.parity_gate.json`) | **pass** – `check_canonical_phase_history.py` exited 0 for all 14 games (no canonical `(phase, moveType)` contract violations under the Python `GameEngine.apply_move` replay path)                 | `parity_divergent`    | DB now contains 14 square8 2p `selfplay_soak` games recorded via the canonical Python engine/DB writer. Canonical phase-history invariants hold for every recorded move, but TS replay parity still reports 14 structural issues, all of the form `[PHASE_MOVE_INVARIANT] Cannot apply move type 'place_ring' in phase 'territory_processing'` when the TS harness attempts to simulate the second player's ring placement immediately after a `no_line_action` territory-processing step. Treat this DB as non-canonical training data pending a dedicated parity fix; do not promote it to the canonical allowlist until both `passed_canonical_parity_gate` and `canonical_ok` become true. |
| `selfplay.db`                   | [`ai-service/data/games/selfplay.db`](ai-service/data/games/selfplay.db:1)                                 | square8 / mixed (2–4p; currently **0 games**) | not_listed (implicit legacy/self-play/debug)    | **pass** – `games_with_semantic_divergence = 0`, `games_with_structural_issues = 0`, `total_games_checked = 0`                                                 | **pass** – no canonical phase-history violations (0 games)                                                                                                                                          | `canonical` (empty)   | Former mixed self-play DB; after 2025-12-08 cleanup it now contains **0 games**. Safe for tooling smoke-tests but not a useful canonical training source. Historical parity failures referenced in older snapshots applied to a previous, now-deleted incarnation of this DB.                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `selfplay_square8_2p.db`        | [`ai-service/data/games/selfplay_square8_2p.db`](ai-service/data/games/selfplay_square8_2p.db:1)           | square8 / 2p (currently **0 games**)          | not_listed (self-play only)                     | **pass** – `games_with_semantic_divergence = 0`, `games_with_structural_issues = 0`, `total_games_checked = 0`                                                 | **pass** – no canonical phase-history violations (0 games)                                                                                                                                          | `canonical` (empty)   | Empty square8 2p self-play shell; parity + history gates pass vacuously. Suitable as a target path for future canonical self-play, but contains no data at present.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `selfplay_square8_3p.db`        | [`ai-service/data/games/selfplay_square8_3p.db`](ai-service/data/games/selfplay_square8_3p.db:1)           | square8 / 3p (currently **0 games**)          | not_listed (self-play only)                     | **pass** – `games_with_semantic_divergence = 0`, `games_with_structural_issues = 0`, `total_games_checked = 0`                                                 | **pass** – no canonical phase-history violations (0 games)                                                                                                                                          | `canonical` (empty)   | Same pattern as 2p: currently an empty 3p shell DB; passes gates but is not yet a meaningful training source.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `selfplay_square8_4p.db`        | [`ai-service/data/games/selfplay_square8_4p.db`](ai-service/data/games/selfplay_square8_4p.db:1)           | square8 / 4p (currently **0 games**)          | not_listed (self-play only)                     | **pass** – `games_with_semantic_divergence = 0`, `games_with_structural_issues = 0`, `total_games_checked = 0`                                                 | **pass** – no canonical phase-history violations (0 games)                                                                                                                                          | `canonical` (empty)   | Empty square8 4p self-play DB; semantics + history alignment hold, but there is no recorded gameplay.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `debug_square8.db`              | [`ai-service/data/games/debug_square8.db`](ai-service/data/games/debug_square8.db:1)                       | square8 / debug (currently **0 games**)       | not_listed (debug fixture)                      | **pass** – `games_with_semantic_divergence = 0`, `games_with_structural_issues = 0`, `total_games_checked = 0`; created fresh v6 schema on open                | **pass** – no canonical phase-history violations (0 games)                                                                                                                                          | `canonical` (empty)   | Debug-only DB; [`GameReplayDB`](ai-service/app/db/game_replay.py:1) created a fresh v6 schema when opened. Safe for experiments, but contains no games and should not be treated as canonical training data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `square8_2p.db`                 | [`ai-service/data/games/square8_2p.db`](ai-service/data/games/square8_2p.db:1)                             | square8 / 2p (currently **0 games**)          | not_listed (self-play / experiment)             | **pass** – `games_with_semantic_divergence = 0`, `games_with_structural_issues = 0`, `total_games_checked = 0`                                                 | **pass** – no canonical phase-history violations (0 games)                                                                                                                                          | `canonical` (empty)   | Small square8 2p experimental DB; currently empty, so gates pass vacuously.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `square8_3p.db`                 | [`ai-service/data/games/square8_3p.db`](ai-service/data/games/square8_3p.db:1)                             | square8 / 3p (currently **0 games**)          | not_listed (self-play / experiment)             | **pass** – `games_with_semantic_divergence = 0`, `games_with_structural_issues = 0`, `total_games_checked = 0`                                                 | **pass** – no canonical phase-history violations (0 games)                                                                                                                                          | `canonical` (empty)   | Empty 3p experimental DB; included here only to document that it currently carries no data and passes gates vacuously.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `square8_4p.db`                 | [`ai-service/data/games/square8_4p.db`](ai-service/data/games/square8_4p.db:1)                             | square8 / 4p (currently **0 games**)          | not_listed (self-play / experiment)             | **pass** – `games_with_semantic_divergence = 0`, `games_with_structural_issues = 0`, `total_games_checked = 0`                                                 | **pass** – no canonical phase-history violations (0 games)                                                                                                                                          | `canonical` (empty)   | Empty 4p experimental DB; same pattern as other non-victory square8 DBs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `square8_2p.db` (victory study) | [`ai-service/data/games/victory_study/square8_2p.db`](ai-service/data/games/victory_study/square8_2p.db:1) | square8 / 2p                                  | not_listed (victory-study only)                 | **fail** – `games_with_semantic_divergence = 6`, `games_with_structural_issues = 13`, `total_games_checked = 19`                                               | **fail** – multiple canonical phase-history violations: early `no_territory_action` recorded while `currentPhase = ring_placement`, plus later `process_territory_region` moves in `ring_placement` | `legacy_noncanonical` | Victory-study DB for UX analysis. Contains structurally **non-canonical** histories and TS replay structural errors (`[PHASE_MOVE_INVARIANT] Cannot apply move type 'process_territory_region' in phase 'ring_placement'`), so it must not be used as canonical training data.                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `square8_3p.db` (victory study) | [`ai-service/data/games/victory_study/square8_3p.db`](ai-service/data/games/victory_study/square8_3p.db:1) | square8 / 3p                                  | not_listed (victory-study only)                 | **fail** – `games_with_semantic_divergence = 5`, `games_with_structural_issues = 9`, `total_games_checked = 14`                                                | **fail** – same canonical phase-history violation pattern as 2p (no_territory_action in `ring_placement` and later territory moves recorded against `ring_placement` states)                        | `legacy_noncanonical` | Useful for multi-player victory/UX case studies but structurally non-canonical for both parity and history; retain only for analysis, not for canonical training.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `square8_4p.db` (victory study) | [`ai-service/data/games/victory_study/square8_4p.db`](ai-service/data/games/victory_study/square8_4p.db:1) | square8 / 4p                                  | not_listed (victory-study only)                 | **fail** – `games_with_semantic_divergence = 1`, `games_with_structural_issues = 5`, `total_games_checked = 6`                                                 | **fail** – canonical phase-history violations at move 3 and later: `no_territory_action` and `process_territory_region` recorded in `ring_placement`                                                | `legacy_noncanonical` | Mirroring 2p/3p, this DB remains structurally non-canonical due to early-phase territory bookkeeping recorded against `ring_placement`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `canonical_square19.db`         | _(not present on disk)_                                                                                    | square19 / 2p (implied)                       | **pending_gate** (registry gate notes)          | **not_checked** – DB file not found under [`ai-service/data/games/`](ai-service/data/games:1) in P2c.1                                                         | **not_checked** – no DB to replay                                                                                                                                                                   | `legacy_noncanonical` | Registry notes already flag this as needing regeneration; parity/canonical-history gates were **not** re-run in P2c.1.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `canonical_hex.db`              | _(removed)_                                                                                                | hex / radius-12 target                        | removed / deprecated (see hex deprecation docs) | **not_checked** – DB intentionally removed                                                                                                                     | **not_checked** – DB intentionally removed                                                                                                                                                          | `legacy_noncanonical` | Hex canonical data remains deprecated pending a fresh radius-12 DB; see [`HEX_DATA_DEPRECATION_NOTICE.md`](ai-service/data/HEX_DATA_DEPRECATION_NOTICE.md:1) and [`HEX_ARTIFACTS_DEPRECATED.md`](ai-service/docs/HEX_ARTIFACTS_DEPRECATED.md:1).                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `selfplay_aws.db`               | _(not present on disk)_                                                                                    | square8 / mixed (legacy AWS self-play)        | not_listed (legacy AWS self-play; historical)   | **not_checked** – legacy DB file no longer present locally in `ai-service/data/games/`                                                                         | **not_checked** – legacy DB not available for replay                                                                                                                                                | `legacy_noncanonical` | Historically this DB was strongly non-canonical (many semantic divergences and structural issues). It has since been removed from the local environment; keep any prior references as historical context only.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

## Narrative Summary

- **Square8 DB status after P2c.1 (diagnostic) and the P2c.2 local regeneration attempt:**
  - [`canonical_square8.db`](ai-service/data/games/canonical_square8.db:1) now contains 14 square8 2p `selfplay_soak` games and is **parity-divergent**: TS replay parity reports `games_with_structural_issues = 14`, `games_with_semantic_divergence = 0`, and `total_games_checked = 14` (see [`canonical_square8.db.parity_gate.json`](ai-service/data/games/canonical_square8.db.parity_gate.json:1)), with every structural issue coming from `[PHASE_MOVE_INVARIANT] Cannot apply move type 'place_ring' in phase 'territory_processing'` when the TS harness attempts to simulate the second player's ring placement immediately after a `no_line_action` territory-processing step. Canonical phase-history checks still pass for all games, so the Python DB writer + FSM respect the `(phase, moveType)` contract even though TS replay cannot yet reproduce the same sequence.
  - The other non-victory square8 DBs (`selfplay.db`, `selfplay_square8_*`, `square8_*`, [`debug_square8.db`](ai-service/data/games/debug_square8.db:1)) remain empty v6 shells with zero games; their parity + canonical-history gates still pass vacuously and they remain unsuitable as canonical training sources until populated via the canonical generator.
- The three victory-study square8 DBs (`square8_2p/3p/4p`) remain **structurally non-canonical**:
  - They exhibit mid-game TS↔Python semantic divergences (`current_player`, `current_phase`, `state_hash`) shortly after the very first moves (typically at `diverged_at = 3`).
  - Canonical phase-history replay reports repeated violations where `no_territory_action` or `process_territory_region` moves are recorded while `currentPhase = ring_placement`, violating the phase→MoveType invariant enforced by [`GameEngine._assert_phase_move_invariant()`](ai-service/app/game_engine.py:631).
  - These DBs should continue to be treated as **legacy_noncanonical**: valuable for UX/victory analysis and parity debugging, but not suitable as canonical training sources.
- `selfplay_aws.db` is no longer present locally; prior gate results that marked it as strongly non-canonical remain valid historically, but it is no longer part of the active training data surface.
- `canonical_square19.db` and `canonical_hex.db` were **not** re-gated in P2c.1; they remain pending regeneration and gating before any square19/hex canonical training.

## Commands Used (P2c.1)

All commands were run from the monorepo root (`/Users/armand/Development/RingRift`):

```bash
# Discovery
cd ai-service
find . -name "*.db" -print

# Parity + canonical-history gates (square8-focused)
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/canonical_square8.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/selfplay.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/selfplay_square8_2p.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/selfplay_square8_3p.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/selfplay_square8_4p.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/debug_square8.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/square8_2p.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/square8_3p.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/square8_4p.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/victory_study/square8_2p.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/victory_study/square8_3p.db
PYTHONPATH=ai-service python ai-service/scripts/run_parity_and_history_gate.py --db ai-service/data/games/victory_study/square8_4p.db
```

## Next Steps (for Future Parity Tasks)

1. **Regenerate `canonical_square8.db` off-sandbox** using [`generate_canonical_selfplay.py`](ai-service/scripts/generate_canonical_selfplay.py:1) on a host without SHM/OMP restrictions, then:
   - Re-run TS↔Python parity with `--fail-on-divergence` and `--emit-state-bundles-dir`,
   - Re-run canonical phase-history checks,
   - Update [`TRAINING_DATA_REGISTRY.md`](ai-service/TRAINING_DATA_REGISTRY.md:1) only once `canonical_ok` and `passed_canonical_parity_gate` are both true **and** the DB contains at least one game.
2. **Create fresh canonical DBs** for square19 and hex (unchanged from previous plan):
   - `canonical_square19.db` (currently zero games / missing locally).
   - A new `canonical_hex.db` using the radius-12 geometry, consistent with [`HEX_ARTIFACTS_DEPRECATED.md`](ai-service/docs/HEX_ARTIFACTS_DEPRECATED.md:1).
3. **Keep legacy/self-play/victory DBs out of the canonical allowlist**:
   - Treat the victory-study DBs and any legacy self-play DBs (`selfplay_aws.db`, historical copies of [`selfplay.db`](ai-service/data/games/selfplay.db:1), etc.) as **legacy_noncanonical** for training, while retaining them for debugging and UX analysis.
4. **Use parity fixtures/state bundles selectively** (outside this diagnostic subtask) to debug any remaining divergences, especially around `process_territory_region` and terminal game-over handling on square8 in the victory-study DBs.

_Last updated: 2025-12-09 (P2c.1 – square8 parity & canonical-history re-gate after FSM alignment)_
