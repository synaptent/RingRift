# P18.5-4 – Pie-Rule (swap_sides) Parity and Visibility Audit Report

**Date:** 2025-12-01  
**Status:** ✅ COMPLETE  
**Scope:** TypeScript, Python, and Frontend

---

## Executive Summary

The pie rule (swap_sides) has been audited across all three layers (TypeScript shared engine, Python rules engine, and Frontend UX). The implementation is complete and consistent across all hosts. Test infrastructure issues were identified and fixed in the TypeScript test suite.

**Test Results:**

- TypeScript swap rule tests: **5/5 PASSED**
- Python swap rule tests: **2/2 PASSED**
- Parity healthcheck: **0 mismatches** (43 cases)

---

## Audit Findings by Layer

### 1. TypeScript Implementation (✅ COMPLETE)

#### 1.1 Shared Engine (`src/shared/engine/`)

- **ActionType** in `types.ts` does NOT include 'swap_sides' — this is intentional
- Swap is a **host-level meta-move**, not a shared action type
- `MoveType` in `src/shared/types/game.ts` DOES include 'swap_sides'

#### 1.2 Server GameEngine (`src/server/game/GameEngine.ts`)

**Implementation:**

- `shouldOfferSwapSidesMetaMove()` (lines 3793-3825) — gating logic for when swap is valid
- `applySwapSidesMove()` (lines 275-436) — applies swap by swapping player identities, preserving seat stats
- `getValidMoves()` (lines 3731-3755) — surfaces swap_sides when `shouldOfferSwapSidesMetaMove()` returns true
- `_swapSidesApplied` flag (line 192) — internal tracking (not used for gating, moveHistory is authoritative)

**Gating Conditions:**

1. `rulesOptions.swapRuleEnabled === true`
2. `gameStatus === 'active'`
3. `players.length === 2`
4. `currentPlayer === 2`
5. `currentPhase` is interactive (ring_placement, movement, capture, chain_capture)
6. `moveHistory.length > 0`
7. No prior swap_sides move exists
8. At least one P1 move exists, no P2 moves yet

#### 1.3 ClientSandboxEngine (`src/client/sandbox/ClientSandboxEngine.ts`)

**Implementation:**

- `shouldOfferSwapSidesMetaMove()` (lines 1435-1461) — mirrors backend gating
- `canCurrentPlayerSwapSides()` (lines 1467-1469) — public accessor
- `applySwapSidesForCurrentPlayer()` (lines 1492-1553) — full swap implementation
- Constructor enables `swapRuleEnabled` for 2-player games (lines 393-397)

---

### 2. Python Implementation (✅ COMPLETE)

#### 2.1 Game Engine (`ai-service/app/game_engine.py`)

- `_should_offer_swap_sides()` (lines 373-420) — mirrors TS gating logic
- `_apply_swap_sides()` (lines 315-370) — swaps player identities
- `get_valid_moves()` surfaces `SWAP_SIDES` when valid

#### 2.2 Rules Engine (`ai-service/app/rules/default_engine.py`)

- `validate_move()` has special-case for SWAP_SIDES (lines 113-127)
- `_apply_move_with_mutators()` skips mutator application for SWAP_SIDES

---

### 3. Frontend UX (✅ COMPLETE)

#### 3.1 BackendGameHost (`src/client/pages/BackendGameHost.tsx`)

Lines 1172-1192:

```tsx
gameState.players.length === 2 &&
gameState.rulesOptions?.swapRuleEnabled === true &&
// Shows swap UI with button that calls submitMove({ type: 'swap_sides', ... })
```

#### 3.2 SandboxGameHost (`src/client/pages/SandboxGameHost.tsx`)

Lines 1199-1206:

```tsx
sandboxEngine.canCurrentPlayerSwapSides() && (
  <div>Pie rule available: swap colours with Player 1.</div>
);
```

#### 3.3 GameHUD (`src/client/components/GameHUD.tsx`)

- Displays `pieRuleSummary` badge showing swap rule status

#### 3.4 GameEventLog (`src/client/components/GameEventLog.tsx`)

- Properly formats swap_sides moves in move history

---

## Issues Found and Fixed

### Test Infrastructure Issue

**Problem:** TypeScript swap rule tests (`tests/unit/GameEngine.swapRule.test.ts`) were failing because:

1. Tests bypassed proper game initialization by directly setting `gameStatus = 'active'`
2. The GameEngine constructor sets `isReady = (p.type === 'ai')` for all players, so human players were not marked ready
3. With orchestrator adapter enabled (default), moves require properly initialized game state

**Solution:** Updated the test helper `createActiveGame()` to:

1. Mark all players as ready before calling `startGame()`
2. Use proper `engine.startGame()` instead of manually setting `gameStatus`

**Files Modified:**

- `tests/unit/GameEngine.swapRule.test.ts` — Fixed test setup to properly initialize game state

---

## Test Coverage Summary

### TypeScript Tests (`tests/unit/GameEngine.swapRule.test.ts`)

| Test                                                                  | Status  |
| --------------------------------------------------------------------- | ------- |
| rejects swap_sides before Player 1 has moved                          | ✅ PASS |
| applies swap_sides by swapping player seats but not board geometry    | ✅ PASS |
| does not offer swap_sides when swapRuleEnabled is false               | ✅ PASS |
| offers swap_sides exactly once after P1 first turn in active 2p games | ✅ PASS |
| never offers swap_sides in non-active or non-2p games                 | ✅ PASS |

### Python Tests (`ai-service/tests/test_swap_rule.py`)

| Test                                                                   | Status  |
| ---------------------------------------------------------------------- | ------- |
| test_swap_rule_offered_exactly_once_for_player_two_after_p1_first_move | ✅ PASS |
| test_default_rules_engine_apply_swap_sides_swaps_identities_not_stats  | ✅ PASS |

### Parity Healthcheck

- **Total cases:** 43
- **Mismatches:** 0
- **Suites:** contract_vectors_v2, plateau_snapshots

---

## Edge Cases and Limitations

### Currently Handled

1. ✅ Swap only available in 2-player games
2. ✅ Swap only available for Player 2
3. ✅ Swap only available after P1's first complete turn
4. ✅ Swap only available before P2's first non-swap move
5. ✅ Swap cannot be applied twice
6. ✅ Swap requires `swapRuleEnabled` to be true
7. ✅ Swap is blocked in non-active games
8. ✅ Swap is blocked during line_processing or territory_processing phases
9. ✅ Board geometry is preserved during swap
10. ✅ Per-seat stats (eliminatedRings, territorySpaces, ringsInHand) stay with seats
11. ✅ Time budgets stay with seats

### Known Limitations

1. **Frontend 2P default:** Swap rule is automatically enabled for 2-player sandbox games but requires explicit opt-in for backend/lobby games
2. **AI consideration:** The Python AI doesn't have special heuristics for whether to accept/decline the swap offer
3. **No undo:** Once swap is applied, there is no undo mechanism

---

## Parity Verification

| Behaviour                  | TypeScript (Backend) | TypeScript (Sandbox) | Python       |
| -------------------------- | -------------------- | -------------------- | ------------ |
| Gating conditions          | ✅ Identical         | ✅ Identical         | ✅ Identical |
| Identity swap semantics    | ✅                   | ✅                   | ✅           |
| Stat preservation on seats | ✅                   | ✅                   | ✅           |
| Time budget preservation   | ✅                   | ✅                   | ✅           |
| MoveHistory recording      | ✅                   | ✅                   | ✅           |
| Phase/turn preservation    | ✅                   | ✅                   | ✅           |

---

## Conclusion

The pie rule (swap_sides) is fully implemented and tested across all three layers. The test infrastructure issue has been resolved. All swap-related tests pass, and the parity healthcheck confirms 0 mismatches between TypeScript and Python engines.

**No further work required for P18.5-4.**
