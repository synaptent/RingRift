# Parity CI Gate - TS↔Python Replay Parity
#
# This workflow runs TS↔Python replay parity checks on PRs that affect engine
# code. It ensures that changes to the rules engine don't introduce semantic
# divergences between the TypeScript and Python implementations.
#
# The check generates fresh canonical databases on-the-fly (3 games each):
#   - canonical_square8.db (2-player)
#   - canonical_square8_3p.db (3-player)
#   - canonical_square8_4p.db (4-player)
#
# This approach ensures:
#   - Fresh games test the current codebase (no stale DB issues)
#   - DBs are gitignored (not stored in repo)
#   - Replay tolerance coercion is validated (RR-CANON-R073/R075/R076)
#
# The full parity healthcheck (contract vectors, plateau snapshots) runs as
# part of the existing python-parity-healthcheck job in ci.yml.
#
# Related documentation:
#   - RULES_CANONICAL_SPEC.md (canonical rules SSOT)
#   - docs/PARITY_VERIFICATION_RUNBOOK.md
#   - ai-service/TRAINING_DATA_REGISTRY.md
#
# Exit codes:
#   0 = All games pass parity
#   1 = Semantic divergences detected (build fails)
#
# Implementation: PA-6 (Automate Parity CI Gate)

name: Parity CI Gate

on:
  pull_request:
    branches: [main, develop]
    paths:
      # TypeScript engine paths
      - 'src/shared/engine/**'
      - 'src/client/sandbox/**'
      - 'scripts/selfplay-db-ts-replay.ts'
      # Python engine paths
      - 'ai-service/app/game_engine.py'
      - 'ai-service/app/rules/**'
      - 'ai-service/app/db/game_replay.py'
      - 'ai-service/app/models/core.py'
      # Parity scripts themselves
      - 'ai-service/scripts/check_ts_python_replay_parity.py'
      - 'ai-service/scripts/run_parity_healthcheck.py'
      # Canonical databases
      - 'ai-service/data/games/canonical_*.db'
      # This workflow
      - '.github/workflows/parity-ci.yml'
  # Allow manual triggering for debugging
  workflow_dispatch: {}

jobs:
  replay-parity-check:
    name: TS↔Python Replay Parity
    runs-on: ubuntu-latest
    # CI Safety: Game generation + parity check should complete within 20 minutes
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # TS replay requires Node.js and npm dependencies
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      # Python for the parity checker
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Generate canonical DB on-the-fly (gitignored, not stored in repo)
      # This ensures fresh games are tested and avoids stale DB issues
      - name: Generate canonical 2P games
        working-directory: ai-service
        env:
          PYTHONPATH: '.'
          RINGRIFT_SKIP_SHADOW_CONTRACTS: 'true'
        run: |
          mkdir -p data/games
          python scripts/run_self_play_soak.py \
            --board-type square8 \
            --num-players 2 \
            --num-games 3 \
            --record-db data/games/canonical_square8.db \
            --log-jsonl /tmp/canonical_2p.jsonl \
            --engine-mode mixed \
            --difficulty-band light

      # Run the replay parity check on canonical_square8.db
      - name: Run TS↔Python replay parity check
        working-directory: ai-service
        env:
          PYTHONPATH: '.'
          # Use server tsconfig for ts-node
          TS_NODE_PROJECT: '../tsconfig.server.json'
        run: |
          python scripts/check_ts_python_replay_parity.py \
            --db data/games/canonical_square8.db \
            --fail-on-divergence \
            --summary-json results/parity_ci_summary.json

      # Upload summary artifact for debugging failed builds
      - name: Upload parity check summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-ci-summary
          path: ai-service/results/parity_ci_summary.json
          retention-days: 14
          if-no-files-found: ignore

  # 3-player parity check (CI-blocking)
  replay-parity-check-3p:
    name: TS↔Python Replay Parity (3-player)
    runs-on: ubuntu-latest
    # 3P games take longer to generate
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Generate canonical 3P DB on-the-fly
      - name: Generate canonical 3P games
        working-directory: ai-service
        env:
          PYTHONPATH: '.'
          RINGRIFT_SKIP_SHADOW_CONTRACTS: 'true'
        run: |
          mkdir -p data/games
          python scripts/run_self_play_soak.py \
            --board-type square8 \
            --num-players 3 \
            --num-games 3 \
            --record-db data/games/canonical_square8_3p.db \
            --log-jsonl /tmp/canonical_3p.jsonl \
            --engine-mode mixed \
            --difficulty-band light

      - name: Run TS↔Python replay parity check (3-player)
        working-directory: ai-service
        env:
          PYTHONPATH: '.'
          TS_NODE_PROJECT: '../tsconfig.server.json'
        run: |
          python scripts/check_ts_python_replay_parity.py \
            --db data/games/canonical_square8_3p.db \
            --fail-on-divergence \
            --summary-json results/parity_ci_3p_summary.json

      - name: Upload parity check summary (3-player)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-ci-3p-summary
          path: ai-service/results/parity_ci_3p_summary.json
          retention-days: 14
          if-no-files-found: ignore

  # 4-player parity check (CI-blocking)
  replay-parity-check-4p:
    name: TS↔Python Replay Parity (4-player)
    runs-on: ubuntu-latest
    # 4P games take longest to generate
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Generate canonical 4P DB on-the-fly
      - name: Generate canonical 4P games
        working-directory: ai-service
        env:
          PYTHONPATH: '.'
          RINGRIFT_SKIP_SHADOW_CONTRACTS: 'true'
        run: |
          mkdir -p data/games
          python scripts/run_self_play_soak.py \
            --board-type square8 \
            --num-players 4 \
            --num-games 3 \
            --record-db data/games/canonical_square8_4p.db \
            --log-jsonl /tmp/canonical_4p.jsonl \
            --engine-mode mixed \
            --difficulty-band light

      - name: Run TS↔Python replay parity check (4-player)
        working-directory: ai-service
        env:
          PYTHONPATH: '.'
          TS_NODE_PROJECT: '../tsconfig.server.json'
        run: |
          python scripts/check_ts_python_replay_parity.py \
            --db data/games/canonical_square8_4p.db \
            --fail-on-divergence \
            --summary-json results/parity_ci_4p_summary.json

      - name: Upload parity check summary (4-player)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-ci-4p-summary
          path: ai-service/results/parity_ci_4p_summary.json
          retention-days: 14
          if-no-files-found: ignore

  # Optional: Run against additional canonical DBs if they exist
  # This job is allowed to fail and won't block the PR
  extended-parity-check:
    name: Extended Parity Check (Non-Blocking)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # This job runs in parallel but doesn't block PRs
    continue-on-error: true
    # Only run on main branch to save CI time on feature branches
    if: github.base_ref == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Run parity check on all available DBs (scan mode)
      - name: Run extended parity check
        working-directory: ai-service
        env:
          PYTHONPATH: '.'
          TS_NODE_PROJECT: '../tsconfig.server.json'
        run: |
          python scripts/check_ts_python_replay_parity.py \
            --limit-games-per-db 5 \
            --summary-json results/parity_extended_summary.json

      - name: Upload extended parity summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-extended-summary
          path: ai-service/results/parity_extended_summary.json
          retention-days: 14
          if-no-files-found: ignore
