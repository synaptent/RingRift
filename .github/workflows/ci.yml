name: RingRift CI/CD

# CI job structure plan (rules vs parity vs integration vs Python)
#
# Current state:
# - lint-and-typecheck: ESLint + TS compilation for server/client.
# - test: npm run test:coverage (all Jest suites together).
# - build, security-scan, docker-build: packaging and security.
#
# Target state (to be implemented in a future workflow refactor):
# - ts-rules-engine:
#     - Run Jest on rules-level suites only (e.g. *.rules.test.ts,
#       RefactoredEngine*.test.ts, RulesMatrix.*.GameEngine/ClientSandboxEngine
#       when they are acting as pure rules scenarios).
#     - Treated as the canonical semantic signal; failures here should
#       fail CI early.
# - ts-parity:
#     - Run Jest on trace/parity suites (Backend_vs_Sandbox.*traceParity*.
#       test.ts, *Parity.RuleEngine_vs_Sandbox.test.ts,
#       Python_vs_TS.traceParity.test.ts, RNG parity, etc.).
#     - Used as smoke/regression coverage; failures are investigated with
#       the rules-over-traces policy (stale traces may be regenerated or
#       seeds retired in favour of focused rules tests).
# - ts-integration:
#     - Run Jest on integration-level suites (WebSocketServer.*.integration,
#       GameEngine.*WebSocketIntegration, FullGameFlow, route tests,
#       snapshot tests, etc.).
# - python-core:
#     - Run pytest for non-parity Python tests
#       (test_engine_correctness, test_env_interface, AI unit tests).
# - python-rules-parity:
#     - Run pytest on parity tests marked as rules-parity
#       (ai-service/tests/parity/* using TS-generated fixtures).
#     - Depends on TS fixture generation step that calls a small Node
#       script under tests/scripts/generate_rules_parity_fixtures.ts.
#
# When implementing this split, prefer:
# - rules-level jobs (ts-rules-engine, python-rules-parity) as the
#   highest-priority signals;
# - parity jobs as secondary, explicitly documenting when failures
#   indicate stale traces vs true rules regressions.

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    # CI Safety: Prevent jobs from hanging indefinitely
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint -- --format stylish

      - name: Run TypeScript type check
        run: npx tsc --noEmit

      - name: Run server TypeScript check
        run: npx tsc -p tsconfig.server.json --noEmit

      - name: Run client TypeScript check
        run: npx tsc -p tsconfig.client.json --noEmit

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    # CI Safety: Prevent test jobs from hanging indefinitely
    # 30 minutes allows for full test suite execution while catching hangs
    timeout-minutes: 30
    env:
      # TS shared engine is authoritative; orchestrator adapter is ON by default.
      # Legacy/SHADOW modes run only in explicit diagnostic jobs.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100
      ORCHESTRATOR_SHADOW_MODE_ENABLED: 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true

  ts-rules-engine:
    name: TS Rules Engine (rules-level)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Prevent test jobs from hanging indefinitely
    timeout-minutes: 20
    env:
      # Rules-level suites run with TS authoritative + orchestrator adapter enabled.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100
      ORCHESTRATOR_SHADOW_MODE_ENABLED: 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TS rules-engine Jest suites
        run: npm run test:ts-rules-engine

  ts-orchestrator-parity:
    name: TS Orchestrator Parity (adapter-ON)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Focused orchestrator parity lane
    timeout-minutes: 20
    env:
      # Orchestrator‑ON profile: shared TS engine + adapters are canonical.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100
      ORCHESTRATOR_SHADOW_MODE_ENABLED: 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run orchestrator parity suite (TS)
        run: npm run test:orchestrator-parity

  ts-parity:
    name: TS Parity (trace-level & host parity)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Trace/parity lane; kept separate from rules-level gates
    timeout-minutes: 20
    env:
      # Orchestrator‑ON profile for parity runs; shared TS engine is canonical.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100
      ORCHESTRATOR_SHADOW_MODE_ENABLED: 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TS parity / trace suites
        run: npm run test:ts-parity

  ts-integration:
    name: TS Integration (routes, WebSocket, AI integration)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Integration lane; exercises service wiring & transport
    timeout-minutes: 25
    env:
      # Integration tests exercise orchestrator-ON semantics by default.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100
      ORCHESTRATOR_SHADOW_MODE_ENABLED: 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TS integration suites
        run: npm run test:ts-integration

  ssot-check:
    name: SSoT Drift Guards
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: SSoT checks are fast; keep a tight timeout
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run SSoT enforcement checks
        run: npm run ssot-check

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test]
    # CI Safety: Build should complete quickly
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build server and client
        run: npm run build

      - name: Archive production artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: dist/
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    # CI Safety: Security scans should complete quickly
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Audit Node dependencies (prod, fail on high)
        run: npm audit --production --audit-level=high

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Generate CycloneDX SBOM for Node dependencies
        run: npx @cyclonedx/cyclonedx-npm --output-format JSON --output-file sbom-node.json

      - name: Upload Node SBOM artifact
        uses: actions/upload-artifact@v3
        with:
          name: sbom-node
          path: sbom-node.json
          retention-days: 7

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test]
    # CI Safety: Docker builds can be slow but shouldn't hang
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ringrift:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  python-rules-parity:
    name: Python Rules Parity (fixture-based)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test]
    # CI Safety: Python tests with fixture generation
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (for TS fixtures)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Generate TS→Python rules parity fixtures
        run: npx ts-node tests/scripts/generate_rules_parity_fixtures.ts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python rules-parity tests (fixture-based)
        working-directory: ai-service
        run: python -m pytest tests/parity/test_rules_parity_fixtures.py

  python-core:
    name: Python Core Tests (non-parity)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Core Python tests, excluding parity/fixture generation
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python core test suite (excluding parity)
        working-directory: ai-service
        run: |
          python -m pytest tests --ignore=tests/parity

  python-dependency-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest
    # CI Safety: Dependency audits should be quick
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install pip-audit
        run: python -m pip install pip-audit

      - name: Run pip-audit against ai-service requirements (high/critical only)
        working-directory: ai-service
        run: |
          # Fail the job only on known HIGH or CRITICAL vulnerabilities.
          pip-audit -r requirements.txt --severity HIGH

      - name: Install CycloneDX SBOM generator
        run: python -m pip install cyclonedx-bom

      - name: Generate CycloneDX SBOM for Python dependencies
        working-directory: ai-service
        run: |
          python -m cyclonedx_py environment --output-format json --output-file sbom-python.json

      - name: Upload Python SBOM artifact
        uses: actions/upload-artifact@v3
        with:
          name: sbom-python
          path: ai-service/sbom-python.json
          retention-days: 7

  e2e-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, build]
    # CI Safety: E2E tests with full infrastructure
    timeout-minutes: 30
    # E2E tests are now CI-blocking. Infrastructure (Postgres, Redis) is
    # configured via services below. Playwright config handles retries (2x in CI).
    env:
      CI: true
      # E2E traffic exercises the orchestrator adapter path with TS authoritative.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100
      ORCHESTRATOR_SHADOW_MODE_ENABLED: 'false'
      # Database and Redis URLs for E2E tests
      DATABASE_URL: postgresql://ringrift:ringrift@localhost:5432/ringrift_test
      REDIS_URL: redis://localhost:6379
      JWT_SECRET: e2e-test-jwt-secret
      NODE_ENV: test

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ringrift
          POSTGRES_PASSWORD: ringrift
          POSTGRES_DB: ringrift_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy

      - name: Install Playwright browsers
        # For CI stability and speed, we default to Chromium only.
        # Multi-browser testing (Firefox, WebKit) is available locally:
        #   npx playwright install firefox webkit
        #   npm run test:e2e:all
        # For full browser matrix in CI, change to: npx playwright install --with-deps
        run: npx playwright install chromium --with-deps

      - name: Run Playwright E2E tests
        # Runs only Chromium in CI by default
        # For multi-browser CI (e.g., on releases), use: npm run test:e2e:all
        # Playwright config has retries: 2 in CI for flaky test resilience
        run: npm run test:e2e:chromium

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload E2E test artifacts on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7
