name: RingRift CI/CD

# CI job structure plan (rules vs parity vs integration vs Python)
#
# Current state:
# - lint-and-typecheck: ESLint + TS compilation for server/client.
# - test: npm run test:coverage (all Jest suites together).
# - build, security-scan, docker-build: packaging and security.
#
# Target state (to be implemented in a future workflow refactor):
# - ts-rules-engine:
#     - Run Jest on rules-level suites only (e.g. *.rules.test.ts,
#       RefactoredEngine*.test.ts, RulesMatrix.*.GameEngine/ClientSandboxEngine
#       when they are acting as pure rules scenarios).
#     - Treated as the canonical semantic signal; failures here should
#       fail CI early.
# - ts-parity:
#     - Run Jest on trace/parity suites (Backend_vs_Sandbox.*traceParity*.
#       test.ts, *Parity.RuleEngine_vs_Sandbox.test.ts,
#       Python_vs_TS.traceParity.test.ts, RNG parity, etc.).
#     - Used as smoke/regression coverage; failures are investigated with
#       the rules-over-traces policy (stale traces may be regenerated or
#       seeds retired in favour of focused rules tests).
# - ts-integration:
#     - Run Jest on integration-level suites (WebSocketServer.*.integration,
#       GameEngine.*WebSocketIntegration, FullGameFlow, route tests,
#       snapshot tests, etc.).
# - python-core:
#     - Run pytest for non-parity Python tests
#       (test_engine_correctness, test_env_interface, AI unit tests).
# - python-rules-parity:
#     - Run pytest on parity tests marked as rules-parity
#       (ai-service/tests/parity/* using TS-generated fixtures).
#     - Depends on TS fixture generation step that calls a small Node
#       script under tests/scripts/generate_rules_parity_fixtures.ts.
#
# When implementing this split, prefer:
# - rules-level jobs (ts-rules-engine, python-rules-parity) as the
#   highest-priority signals;
# - parity jobs as secondary, explicitly documenting when failures
#   indicate stale traces vs true rules regressions.

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    # CI Safety: Prevent jobs from hanging indefinitely
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint -- --format stylish

      - name: Run TypeScript type check
        run: npx tsc --noEmit

      - name: Run server TypeScript check
        run: npx tsc -p tsconfig.server.json --noEmit

      - name: Run client TypeScript check
        run: npx tsc -p tsconfig.client.json --noEmit

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    # CI Safety: Prevent test jobs from hanging indefinitely
    # 30 minutes allows for full test suite execution while catching hangs
    timeout-minutes: 30
    env:
      # TS shared engine is authoritative; orchestrator adapter is ON by default.
      # FSM is now canonical (shadow mode removed).
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      # NOTE: ORCHESTRATOR_ROLLOUT_PERCENTAGE and ORCHESTRATOR_SHADOW_MODE_ENABLED
      # have been removed - FSM is now canonical.

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true

  ts-rules-engine:
    name: TS Rules Engine (rules-level)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Prevent test jobs from hanging indefinitely
    timeout-minutes: 20
    env:
      # Rules-level suites run with TS authoritative + orchestrator adapter enabled.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE:
        100
        # FSM Orchestrator is now active by default (canonical orchestrator).

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TS rules-engine Jest suites
        run: npm run test:ts-rules-engine

  ts-orchestrator-parity:
    name: TS Orchestrator Parity (adapter-ON)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Focused orchestrator-ON parity bundle.
    timeout-minutes: 25
    env:
      # Orchestrator adapter is enabled across this suite.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TS orchestrator parity bundle (adapter-ON)
        run: npm run test:orchestrator-parity

  ts-parity:
    name: TS Parity (trace-level & host parity)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Trace/parity lane; kept separate from rules-level gates
    timeout-minutes: 20
    env:
      # Orchestrator‑ON profile for parity runs; shared TS engine is canonical.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TS parity / trace suites
        run: npm run test:ts-parity

  ts-integration:
    name: TS Integration (routes, WebSocket, AI integration)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Integration lane; exercises service wiring & transport
    timeout-minutes: 25
    env:
      # Integration tests exercise orchestrator-ON semantics by default.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TS integration suites
        run: npm run test:ts-integration

  p0-robustness:
    name: P0 Robustness (rules + integration + parity/cancellation)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Focused but heavier P0 bundle; keep bounded
    timeout-minutes: 30
    env:
      # P0 robustness runs under the standard TS + orchestrator-ON profile.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run P0 robustness profile
        run: npm run test:p0-robustness

  orchestrator-soak-smoke:
    name: Orchestrator Invariant Soak (smoke)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Single short backend game via shared orchestrator
    timeout-minutes: 10
    env:
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run orchestrator invariant smoke soak
        run: npm run soak:orchestrator:smoke

  orchestrator-short-soak:
    name: Orchestrator Invariant Soak (short)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, orchestrator-parity]
    # CI Safety: Deterministic short backend soak backing SLO-CI-ORCH-SHORT-SOAK
    timeout-minutes: 15
    env:
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run orchestrator invariant short soak
        run: npm run soak:orchestrator:short

  ssot-check:
    name: SSoT Drift Guards
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: SSoT checks are fast; keep a tight timeout
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run SSoT enforcement checks
        run: npm run ssot-check

      - name: Validate deployment configuration
        run: npm run validate:deployment

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test]
    # CI Safety: Build should complete quickly
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build server and client
        run: npm run build

      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    # CI Safety: Security scans should complete quickly
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Audit Node dependencies (prod, fail on high)
        run: npm audit --production --audit-level=high

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Generate CycloneDX SBOM for Node dependencies
        run: npx @cyclonedx/cyclonedx-npm --output-format JSON --output-file sbom-node.json

      - name: Upload Node SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-node
          path: sbom-node.json
          retention-days: 7

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test]
    # CI Safety: Docker builds can be slow but shouldn't hang
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ringrift:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  ai-service-docker-smoke:
    name: AI Service Docker Build & Torch Import Smoke
    runs-on: ubuntu-latest
    needs: [python-core, python-dependency-audit]
    # CI Safety: AI-service Docker build + minimal runtime smoke test
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ai-service Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: ai-service
          file: ai-service/Dockerfile
          push: false
          tags: ringrift-ai-service:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke test Torch/TorchVision inside ai-service image
        run: |
          docker run --rm ringrift-ai-service:test \
            python -c "import sys, torch, torchvision; print('PYTHON', sys.version); print('TORCH', torch.__version__); print('TORCHVISION', torchvision.__version__)"

  orchestrator-parity:
    name: Orchestrator Parity (TS orchestrator + Python contracts)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Focused orchestrator + contract vectors gate
    timeout-minutes: 25
    env:
      # Orchestrator‑ON profile for parity gating; shared TS engine is canonical.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE: 100

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Run orchestrator parity TS suites
        run: npm run test:orchestrator-parity:ts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python contract vector tests
        run: ./scripts/run-python-contract-tests.sh --verbose

  python-rules-parity:
    name: Python Rules Parity (fixture-based)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test]
    # CI Safety: Python tests with fixture generation
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (for TS fixtures)
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Generate TS→Python rules parity fixtures
        run: npx ts-node tests/scripts/generate_rules_parity_fixtures.ts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python rules-parity tests (fixture-based)
        working-directory: ai-service
        run: python -m pytest tests/parity/test_rules_parity_fixtures.py

  python-core:
    name: Python Core Tests (non-parity)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: Core Python tests, excluding parity/fixture generation
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python core test suite (excluding parity)
        working-directory: ai-service
        run: |
          python -m pytest tests --ignore=tests/parity

  python-ai-healthcheck:
    name: Python AI Self-Play Healthcheck
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, python-core]
    # CI Safety: Bounded AI self-play healthcheck across multiple boards
    timeout-minutes: 30

    env:
      # Keep CI runtime bounded while still exercising mixed AI across
      # square8/square19/hexagonal.
      RINGRIFT_AI_HEALTHCHECK_GAMES: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run AI self-play healthcheck profile
        working-directory: ai-service
        run: |
          python scripts/run_self_play_soak.py \
            --profile ai-healthcheck \
            --log-jsonl results/ai_healthcheck.log.jsonl \
            --summary-json results/ai_healthcheck_summary.json \
            --max-moves 200 \
            --fail-on-anomaly

      - name: Upload AI healthcheck summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-healthcheck-summary
          path: ai-service/results/ai_healthcheck_summary.json
          retention-days: 14

  python-parity-healthcheck:
    name: Python Parity Healthcheck (TS↔Python rules)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, python-core]
    # CI Safety: Bounded Python parity healthcheck across supported suites
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python parity healthcheck
        working-directory: ai-service
        run: |
          python scripts/run_parity_healthcheck.py \
            --profile parity-healthcheck \
            --summary-json results/parity_healthcheck_summary.json \
            --fail-on-mismatch

      - name: Upload parity healthcheck summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-healthcheck-summary
          path: ai-service/results/parity_healthcheck_summary.json
          retention-days: 14

  canonical-selfplay-parity-gate:
    name: Canonical Selfplay Parity Gate (2p/3p/4p)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, python-core]
    # CI Safety: End-to-end selfplay + TS↔Python replay parity gate
    # Runs 3 configs (2p, 3p, 4p) × 5 games each; parity replay adds overhead.
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (for TS parity harness)
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run canonical selfplay parity gate (2-player)
        working-directory: ai-service
        run: |
          mkdir -p results
          PYTHONPATH=. python scripts/run_canonical_selfplay_parity_gate.py \
            --board-type square8 \
            --num-games 5 \
            --num-players 2 \
            --difficulty-band light \
            --db results/canonical_parity_gate_2p.db \
            --summary results/canonical_parity_gate_2p.json \
            --seed 42

      - name: Run canonical selfplay parity gate (3-player)
        working-directory: ai-service
        run: |
          PYTHONPATH=. python scripts/run_canonical_selfplay_parity_gate.py \
            --board-type square8 \
            --num-games 5 \
            --num-players 3 \
            --difficulty-band light \
            --db results/canonical_parity_gate_3p.db \
            --summary results/canonical_parity_gate_3p.json \
            --seed 42

      - name: Run canonical selfplay parity gate (4-player)
        working-directory: ai-service
        run: |
          PYTHONPATH=. python scripts/run_canonical_selfplay_parity_gate.py \
            --board-type square8 \
            --num-games 5 \
            --num-players 4 \
            --difficulty-band light \
            --db results/canonical_parity_gate_4p.db \
            --summary results/canonical_parity_gate_4p.json \
            --seed 42

      - name: Verify all parity gates passed
        working-directory: ai-service
        run: |
          echo "Checking parity gate results..."
          for config in 2p 3p 4p; do
            summary="results/canonical_parity_gate_${config}.json"
            if [ ! -f "$summary" ]; then
              echo "ERROR: Missing summary file $summary"
              exit 1
            fi
            passed=$(python -c "import json; print(json.load(open('$summary'))['passed_canonical_parity_gate'])")
            if [ "$passed" != "True" ]; then
              echo "ERROR: Canonical parity gate FAILED for ${config}"
              cat "$summary"
              exit 1
            fi
            echo "✓ Canonical parity gate PASSED for ${config}"
          done
          echo "All canonical parity gates passed!"

      - name: Upload parity gate summaries
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canonical-parity-gate-summaries
          path: |
            ai-service/results/canonical_parity_gate_*.json
            ai-service/results/canonical_parity_gate_*.db
          retention-days: 14

  python-dependency-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest
    # CI Safety: Dependency audits should be quick
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install pip-audit (pinned CLI supporting --severity)
        run: python -m pip install 'pip-audit>=2.7.0,<3.0.0'

      - name: Run pip-audit against ai-service requirements (HIGH/CRITICAL only)
        working-directory: ai-service
        run: |
          # Fail the job only on known HIGH or CRITICAL vulnerabilities.
          # Canonical invocation for local runs:
          #   cd ai-service && pip-audit -r requirements.txt --severity HIGH
          pip-audit -r requirements.txt --severity HIGH

      - name: Install CycloneDX SBOM generator
        run: python -m pip install cyclonedx-bom

      - name: Generate CycloneDX SBOM for Python dependencies
        working-directory: ai-service
        run: |
          python -m cyclonedx_py environment --output-format json --output-file sbom-python.json

      - name: Upload Python SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-python
          path: ai-service/sbom-python.json
          retention-days: 7

  python-ai-eval:
    name: Python AI Evaluation (baseline vs random)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, python-core]
    # CI Safety: Bounded AI-vs-AI evaluation; small game count for runtime
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run baseline vs random AI evaluation
        working-directory: ai-service
        run: |
          mkdir -p results
          python scripts/evaluate_ai_models.py \
            --player1 baseline_heuristic \
            --player2 random \
            --games 10 \
            --board square8 \
            --seed 42 \
            --output results/ai_eval_baseline_vs_random.json \
            --quiet

      - name: Upload AI evaluation summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-eval-baseline-vs-random
          path: ai-service/results/ai_eval_baseline_vs_random.json
          retention-days: 14

  python-ai-strength-regression:
    name: Python AI Strength Regression Gate
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, python-core]
    # CI Safety: deterministic eval-pool matchups with a gate.
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run strength regression gate (CI preset)
        working-directory: ai-service
        run: |
          mkdir -p results
          python scripts/run_strength_regression_gate.py \
            --mode ci \
            --output-json results/ai_strength_regression_gate.json

      - name: Upload strength regression gate report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-strength-regression-gate
          path: ai-service/results/ai_strength_regression_gate.json
          retention-days: 14

  e2e-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, build]
    # CI Safety: E2E tests with full infrastructure
    timeout-minutes: 30
    # E2E tests are now CI-blocking. Infrastructure (Postgres, Redis) is
    # configured via services below. Playwright config handles retries (2x in CI).
    env:
      CI: true
      # E2E traffic exercises the orchestrator adapter path with TS authoritative.
      RINGRIFT_RULES_MODE: ts
      ORCHESTRATOR_ADAPTER_ENABLED: 'true'
      ORCHESTRATOR_ROLLOUT_PERCENTAGE:
        100
        # Database and Redis URLs for E2E tests
      DATABASE_URL: postgresql://ringrift:ringrift@localhost:5432/ringrift_test
      REDIS_URL: redis://localhost:6379
      JWT_SECRET: e2e-test-jwt-secret
      NODE_ENV: test

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ringrift
          POSTGRES_PASSWORD: ringrift
          POSTGRES_DB: ringrift_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy

      - name: Install Playwright browsers
        # For CI stability and speed, we default to Chromium only.
        # Multi-browser testing (Firefox, WebKit) is available locally:
        #   npx playwright install firefox webkit
        #   npm run test:e2e:all
        # For full browser matrix in CI, change to: npx playwright install --with-deps
        run: npx playwright install chromium --with-deps

      - name: Run Playwright E2E tests
        # Runs only Chromium in CI by default
        # For multi-browser CI (e.g., on releases), use: npm run test:e2e:all
        # Playwright config has retries: 2 in CI for flaky test resilience
        run: npm run test:e2e:chromium

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload E2E test artifacts on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  load-tests-validation:
    name: Load Tests Validation (k6 syntax)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    # CI Safety: k6 validation is fast, just checking syntax
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Validate k6 script syntax
        working-directory: tests/load
        run: |
          k6 version
          k6 inspect scenarios/game-creation.js
          k6 inspect scenarios/concurrent-games.js
          k6 inspect scenarios/player-moves.js
          k6 inspect scenarios/websocket-stress.js
          k6 inspect scenarios/websocket-gameplay.js
