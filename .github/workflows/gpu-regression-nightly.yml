name: GPU Training Regression (Nightly)

# Per Section 3.3.3 of the action plan:
# Nightly GPU regression tests to catch training pipeline issues early.
# Tests run on self-hosted GPU runners when available, or skip gracefully.

on:
  schedule:
    # Run once per day at 04:00 UTC (before other nightly jobs)
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      run_gpu_tests:
        description: 'Run GPU-specific tests (requires GPU runner)'
        required: false
        default: 'true'
        type: boolean

jobs:
  # CPU-only tests that verify GPU code paths work without GPU
  cpu-regression:
    name: CPU Training Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run CPU training regression tests
        working-directory: ai-service
        run: |
          # Run tests that don't require GPU (graceful skip for GPU-only tests)
          python -m pytest tests/gpu/test_training_regression.py -v \
            --tb=short \
            -m "not gpu" \
            --junit-xml=results/cpu_regression_results.xml

      - name: Run data validation tests
        working-directory: ai-service
        run: |
          python -m pytest tests/training/test_data_validation.py -v \
            --tb=short \
            --junit-xml=results/data_validation_results.xml

      - name: Run tracing tests
        working-directory: ai-service
        run: |
          python -m pytest tests/test_tracing.py -v \
            --tb=short \
            --junit-xml=results/tracing_results.xml

      - name: Run AI decision log tests
        working-directory: ai-service
        run: |
          python -m pytest tests/test_ai_decision_log.py -v \
            --tb=short \
            --junit-xml=results/decision_log_results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpu-regression-results
          path: ai-service/results/*.xml
          retention-days: 30

  # GPU tests on self-hosted runner (optional)
  gpu-regression:
    name: GPU Training Regression Tests
    runs-on: [self-hosted, gpu]
    timeout-minutes: 60
    # Only run if self-hosted GPU runner is available
    # This job will be skipped if no matching runner exists
    if: ${{ github.event.inputs.run_gpu_tests != 'false' }}
    continue-on-error: true # Don't fail the workflow if GPU runner unavailable

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check CUDA availability
        run: |
          python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
          python -c "import torch; print(f'GPU count: {torch.cuda.device_count()}')"
          nvidia-smi || echo "nvidia-smi not available"

      - name: Install dependencies
        working-directory: ai-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run GPU training regression tests
        working-directory: ai-service
        run: |
          python -m pytest tests/gpu/test_training_regression.py -v \
            --tb=short \
            -m "gpu" \
            --junit-xml=results/gpu_regression_results.xml

      - name: Run GPU parity tests
        working-directory: ai-service
        run: |
          python -m pytest tests/gpu/test_gpu_cpu_parity.py -v \
            --tb=short \
            --junit-xml=results/gpu_parity_results.xml

      - name: Upload GPU test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gpu-regression-results
          path: ai-service/results/*.xml
          retention-days: 30

  # Summary job
  summary:
    name: Regression Test Summary
    runs-on: ubuntu-latest
    needs: [cpu-regression]
    if: always()

    steps:
      - name: Download CPU results
        uses: actions/download-artifact@v8
        with:
          name: cpu-regression-results
          path: results/

      - name: Generate summary
        run: |
          echo "## GPU Training Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CPU Regression Tests" >> $GITHUB_STEP_SUMMARY
          if [ -f results/cpu_regression_results.xml ]; then
            echo "- CPU training regression: Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- CPU training regression: Not found" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f results/data_validation_results.xml ]; then
            echo "- Data validation: Completed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f results/tracing_results.xml ]; then
            echo "- Tracing: Completed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f results/decision_log_results.xml ]; then
            echo "- AI decision log: Completed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
