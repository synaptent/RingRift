# =============================================================================
# RingRift Prometheus Alerting Rules
# =============================================================================
#
# This file defines alerting rules for monitoring the RingRift application.
# These rules should be loaded by Prometheus via the rule_files configuration.
#
# Alert Categories:
# - Availability: Service up/down, critical error rates
# - Latency: Response time thresholds
# - Resources: Memory, event loop lag
# - Business: Game activity, AI service health
# - Degradation: Service status changes
# - Rate Limiting: Excessive rate limit hits
#
# Severity Levels:
# - critical: Immediate attention required, potential outage
# - warning: Investigation needed, degraded experience
# - info: Informational, no immediate action required
#
# =============================================================================

groups:
  # ===========================================================================
  # AVAILABILITY ALERTS
  # ===========================================================================
  - name: availability
    interval: 30s
    rules:
      # -------------------------------------------------------------------------
      # Service Down - Database
      # -------------------------------------------------------------------------
      - alert: DatabaseDown
        expr: ringrift_service_status{service="database"} == 0
        for: 1m
        labels:
          severity: critical
          team: backend
          component: database
        annotations:
          summary: 'Database service is down'
          description: 'The database service has been unavailable for more than 1 minute. This affects all data operations.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/DATABASE_DOWN.md'
          impact: 'All game operations, user authentication, and data persistence are unavailable.'

      # -------------------------------------------------------------------------
      # Service Down - Redis
      # -------------------------------------------------------------------------
      - alert: RedisDown
        expr: ringrift_service_status{service="redis"} == 0
        for: 1m
        labels:
          severity: critical
          team: backend
          component: redis
        annotations:
          summary: 'Redis service is down'
          description: 'The Redis service has been unavailable for more than 1 minute. This affects caching and rate limiting.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/REDIS_DOWN.md'
          impact: 'Rate limiting disabled, session management degraded, increased database load.'

      # -------------------------------------------------------------------------
      # Service Down - AI Service
      # -------------------------------------------------------------------------
      - alert: AIServiceDown
        expr: (ringrift_service_status{service="aiService"} == 0) or (up{job="ringrift-ai-service"} == 0)
        for: 2m
        labels:
          severity: warning
          team: ai
          component: ai-service
        annotations:
          summary: 'AI service is down'
          description: 'The AI service has been unavailable for more than 2 minutes. AI moves will fall back to local heuristics.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/AI_SERVICE_DOWN.md'
          impact: 'AI player games continue with reduced move quality via local fallback.'

      # -------------------------------------------------------------------------
      # High Error Rate (5xx responses)
      # -------------------------------------------------------------------------
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'High HTTP 5xx error rate ({{ $value | humanizePercentage }})'
          description: 'More than 5% of HTTP requests are returning 5xx errors over the last 5 minutes.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/HIGH_ERROR_RATE.md'
          impact: 'Users experiencing failures on {{ $value | humanizePercentage }} of requests.'

      # -------------------------------------------------------------------------
      # Elevated Error Rate (Warning)
      # -------------------------------------------------------------------------
      - alert: ElevatedErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.01
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Elevated HTTP 5xx error rate ({{ $value | humanizePercentage }})'
          description: 'More than 1% of HTTP requests are returning 5xx errors over the last 10 minutes.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/HIGH_ERROR_RATE.md'
          impact: 'Some users experiencing intermittent failures.'

      # -------------------------------------------------------------------------
      # No HTTP Traffic
      # -------------------------------------------------------------------------
      - alert: NoHTTPTraffic
        expr: sum(rate(http_requests_total[5m])) == 0
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'No HTTP traffic detected'
          description: 'No HTTP requests have been received in the last 10 minutes. This may indicate the service is unreachable.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/NO_TRAFFIC.md'
          impact: 'Service may be down or unreachable from clients.'

  # ===========================================================================
  # LATENCY ALERTS
  # ===========================================================================
  - name: latency
    interval: 30s
    rules:
      # -------------------------------------------------------------------------
      # High P99 Latency - Warning (2s)
      # -------------------------------------------------------------------------
      - alert: HighP99Latency
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High P99 latency ({{ $value | humanizeDuration }})'
          description: '99th percentile HTTP request latency exceeds 2 seconds. Users may experience slow responses.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/HIGH_LATENCY.md'
          impact: '1% of users experiencing latency > 2 seconds.'

      # -------------------------------------------------------------------------
      # High P99 Latency - Critical (5s)
      # -------------------------------------------------------------------------
      - alert: HighP99LatencyCritical
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 5
        for: 2m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'Critical P99 latency ({{ $value | humanizeDuration }})'
          description: '99th percentile HTTP request latency exceeds 5 seconds. This severely impacts user experience.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/HIGH_LATENCY.md'
          impact: '1% of users experiencing latency > 5 seconds, potential timeouts.'

      # -------------------------------------------------------------------------
      # High P95 Latency
      # -------------------------------------------------------------------------
      - alert: HighP95Latency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High P95 latency ({{ $value | humanizeDuration }})'
          description: '95th percentile HTTP request latency exceeds 1 second sustained for 10 minutes.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/HIGH_LATENCY.md'
          impact: '5% of users experiencing latency > 1 second.'

      # -------------------------------------------------------------------------
      # High P50 Latency (Median)
      # -------------------------------------------------------------------------
      - alert: HighMedianLatency
        expr: histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 0.5
        for: 15m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High median latency ({{ $value | humanizeDuration }})'
          description: 'Median HTTP request latency exceeds 500ms. This indicates general performance degradation.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/HIGH_LATENCY.md'
          impact: '50% of users experiencing latency > 500ms.'

      # -------------------------------------------------------------------------
      # High Game Move Latency
      # -------------------------------------------------------------------------
      - alert: HighGameMoveLatency
        expr: histogram_quantile(0.99, sum(rate(ringrift_game_move_latency_seconds_bucket[5m])) by (le, board_type)) > 1
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High game move processing latency'
          description: '99th percentile game move latency exceeds 1 second on board type {{ $labels.board_type }}.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/GAME_PERFORMANCE.md'
          impact: 'Game responsiveness degraded, moves feel sluggish.'

  # ===========================================================================
  # RESOURCE ALERTS
  # ===========================================================================
  - name: resources
    interval: 30s
    rules:
      # -------------------------------------------------------------------------
      # High Memory Usage - Warning (1.5GB)
      # -------------------------------------------------------------------------
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 / 1024 > 1.5
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High memory usage ({{ $value | humanize1024 }}B)'
          description: 'Process memory usage exceeds 1.5GB. Consider investigating memory leaks or increasing limits.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/HIGH_MEMORY.md'
          impact: 'Risk of OOM if memory continues to grow.'

      # -------------------------------------------------------------------------
      # High Memory Usage - Critical (2GB)
      # -------------------------------------------------------------------------
      - alert: HighMemoryUsageCritical
        expr: process_resident_memory_bytes / 1024 / 1024 / 1024 > 2
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'Critical memory usage ({{ $value | humanize1024 }}B)'
          description: 'Process memory usage exceeds 2GB. OOM kill is imminent if not addressed.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/HIGH_MEMORY.md'
          impact: 'Application may crash due to OOM.'

      # -------------------------------------------------------------------------
      # High Event Loop Lag - Warning (100ms)
      # -------------------------------------------------------------------------
      - alert: HighEventLoopLag
        expr: nodejs_eventloop_lag_seconds > 0.1
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High Node.js event loop lag ({{ $value | humanizeDuration }})'
          description: 'Event loop lag exceeds 100ms. This indicates the main thread is blocked.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/EVENT_LOOP_LAG.md'
          impact: 'All async operations delayed, affecting responsiveness.'

      # -------------------------------------------------------------------------
      # High Event Loop Lag - Critical (500ms)
      # -------------------------------------------------------------------------
      - alert: HighEventLoopLagCritical
        expr: nodejs_eventloop_lag_seconds > 0.5
        for: 2m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'Critical Node.js event loop lag ({{ $value | humanizeDuration }})'
          description: 'Event loop lag exceeds 500ms. The application is severely degraded.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/EVENT_LOOP_LAG.md'
          impact: 'Application effectively unresponsive, requests timing out.'

      # -------------------------------------------------------------------------
      # High Active Handles
      # -------------------------------------------------------------------------
      - alert: HighActiveHandles
        expr: nodejs_active_handles_total > 10000
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High number of active handles ({{ $value }})'
          description: 'More than 10,000 active Node.js handles. This may indicate a resource leak.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/RESOURCE_LEAK.md'
          impact: 'Potential resource exhaustion.'

      # -------------------------------------------------------------------------
      # Cluster Node Memory Pressure
      # -------------------------------------------------------------------------
      - alert: ClusterNodeHighMemory
        expr: ringrift_cluster_node_memory_percent > 85
        for: 10m
        labels:
          severity: warning
          team: ai
          component: cluster
        annotations:
          summary: 'Cluster node {{ $labels.node_id }} high memory usage ({{ $value | printf "%.1f" }}%)'
          description: 'Memory usage on cluster node {{ $labels.node_id }} exceeds 85%. Selfplay jobs may be throttled.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/CLUSTER_HEALTH.md'
          impact: 'Reduced selfplay throughput on affected node.'

      - alert: ClusterNodeCriticalMemory
        expr: ringrift_cluster_node_memory_percent > 95
        for: 5m
        labels:
          severity: critical
          team: ai
          component: cluster
        annotations:
          summary: 'Cluster node {{ $labels.node_id }} critical memory ({{ $value | printf "%.1f" }}%)'
          description: 'Memory usage on cluster node {{ $labels.node_id }} exceeds 95%. OOM imminent.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/CLUSTER_HEALTH.md'
          impact: 'Node may OOM and lose in-progress work.'

      - alert: ClusterNodeHighDisk
        expr: ringrift_cluster_node_disk_percent > 90
        for: 10m
        labels:
          severity: warning
          team: ai
          component: cluster
        annotations:
          summary: 'Cluster node {{ $labels.node_id }} high disk usage ({{ $value | printf "%.1f" }}%)'
          description: 'Disk usage on cluster node {{ $labels.node_id }} exceeds 90%. Data writes may fail.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/CLUSTER_HEALTH.md'
          impact: 'Game database writes and model checkpoints may fail.'

      - alert: ClusterNodeHighGPUMemory
        expr: ringrift_cluster_node_gpu_memory_percent > 90
        for: 5m
        labels:
          severity: warning
          team: ai
          component: cluster
        annotations:
          summary: 'Cluster node {{ $labels.node_id }} high GPU memory ({{ $value | printf "%.1f" }}%)'
          description: 'GPU memory usage on cluster node {{ $labels.node_id }} exceeds 90%.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/CLUSTER_HEALTH.md'
          impact: 'Neural network evaluation may fail or slow down.'

  # ===========================================================================
  # BUSINESS METRIC ALERTS
  # ===========================================================================
  - name: business
    interval: 60s
    rules:
      # -------------------------------------------------------------------------
      # No Active Games (Extended Period)
      # -------------------------------------------------------------------------
      - alert: NoActiveGames
        expr: ringrift_games_active == 0
        for: 30m
        labels:
          severity: info
          team: product
        annotations:
          summary: 'No active games for 30 minutes'
          description: 'There are no active games running. This may be normal during low-traffic periods.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/NO_ACTIVITY.md'
          impact: 'None if expected (off-peak hours), investigate if during peak.'

      # -------------------------------------------------------------------------
      # No WebSocket Connections
      # -------------------------------------------------------------------------
      - alert: NoWebSocketConnections
        expr: ringrift_websocket_connections == 0
        for: 15m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'No WebSocket connections'
          description: 'No active WebSocket connections for 15 minutes. Real-time features unavailable.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/WEBSOCKET_ISSUES.md'
          impact: 'Real-time game updates not working.'

      # -------------------------------------------------------------------------
      # High WebSocket Connection Count
      # -------------------------------------------------------------------------
      - alert: HighWebSocketConnections
        expr: ringrift_websocket_connections > 1000
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High WebSocket connection count ({{ $value }})'
          description: 'More than 1000 WebSocket connections. Consider scaling or investigating connection leaks.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/WEBSOCKET_SCALING.md'
          impact: 'May approach connection limits.'

      # -------------------------------------------------------------------------
      # Game Duration Anomaly (Very Long Games)
      # -------------------------------------------------------------------------
      - alert: LongRunningGames
        expr: |
          histogram_quantile(0.5, 
            sum(rate(ringrift_game_duration_seconds_bucket[1h])) by (le, type)
          ) > 3600
        for: 30m
        labels:
          severity: info
          team: product
        annotations:
          summary: 'Games running unusually long'
          description: 'Median game duration exceeds 1 hour. This may indicate stalled games or unusual gameplay.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/GAME_HEALTH.md'
          impact: 'Possible resource consumption from orphaned games.'

      # -------------------------------------------------------------------------
      # Selfplay Game Outcome Alerts
      # -------------------------------------------------------------------------
      - alert: SelfplayHighDrawRate
        expr: |
          (
            sum(rate(ringrift_game_outcomes_total{outcome="draw"}[1h]))
            /
            (sum(rate(ringrift_games_completed_total[1h])) > 0)
          ) > 0.5
        for: 30m
        labels:
          severity: warning
          team: ai
          component: selfplay
        annotations:
          summary: 'High selfplay draw rate ({{ $value | humanizePercentage }})'
          description: 'More than 50% of selfplay games are ending in draws. This may indicate stale AI or insufficient exploration.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/SELFPLAY_HEALTH.md'
          impact: 'Training data may lack decisive game outcomes, reducing model learning.'

      - alert: SelfplayLowThroughput
        expr: sum(rate(ringrift_games_completed_total[1h])) * 3600 < 10
        for: 1h
        labels:
          severity: warning
          team: ai
          component: selfplay
        annotations:
          summary: 'Low selfplay game throughput (<10 games/hour)'
          description: 'Selfplay is generating fewer than 10 games per hour. Current rate: {{ $value | printf "%.1f" }} games/hour.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/SELFPLAY_HEALTH.md'
          impact: 'Training data generation is slow, delaying model improvement cycles.'

      - alert: SelfplayUnbalancedWinRate
        expr: |
          (
            max(sum by (player_position) (rate(ringrift_game_outcomes_total{outcome=~"player_.*_win"}[6h])))
            /
            (min(sum by (player_position) (rate(ringrift_game_outcomes_total{outcome=~"player_.*_win"}[6h]))) > 0)
          ) > 2
        for: 2h
        labels:
          severity: warning
          team: ai
          component: selfplay
        annotations:
          summary: 'Unbalanced selfplay win rates by player position'
          description: 'One player position is winning more than 2x as often as another. This may indicate first-player advantage or evaluation bias.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/SELFPLAY_HEALTH.md'
          impact: 'Training may be biased toward certain player positions.'

  # ===========================================================================
  # AI SERVICE ALERTS
  # ===========================================================================
  - name: ai-service
    interval: 30s
    rules:
      # -------------------------------------------------------------------------
      # High AI Fallback Rate - Warning (30%)
      # -------------------------------------------------------------------------
      - alert: AIFallbackRateHigh
        expr: |
          (
            sum(rate(ringrift_ai_fallback_total[10m]))
            /
            (sum(rate(ringrift_ai_requests_total[10m])) > 0)
          ) > 0.3
        for: 10m
        labels:
          severity: warning
          team: ai
        annotations:
          summary: 'High AI fallback rate ({{ $value | humanizePercentage }})'
          description: 'More than 30% of AI requests are falling back to local heuristics over the last 10 minutes.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/AI_FALLBACK.md'
          impact: 'AI move quality degraded for ~{{ $value | humanizePercentage }} of requests.'

      # -------------------------------------------------------------------------
      # High AI Fallback Rate - Critical (50%)
      # -------------------------------------------------------------------------
      - alert: AIFallbackRateCritical
        expr: |
          (
            sum(rate(ringrift_ai_fallback_total[5m]))
            /
            (sum(rate(ringrift_ai_requests_total[5m])) > 0)
          ) > 0.5
        for: 5m
        labels:
          severity: critical
          team: ai
        annotations:
          summary: 'Critical AI fallback rate ({{ $value | humanizePercentage }})'
          description: 'More than 50% of AI requests are falling back to local heuristics. AI service may be failing.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/AI_FALLBACK.md'
          impact: 'Most AI games using fallback heuristics.'

      # -------------------------------------------------------------------------
      # AI Request High Latency
      # -------------------------------------------------------------------------
      - alert: AIRequestHighLatency
        expr: histogram_quantile(0.99, sum(rate(ringrift_ai_request_duration_seconds_bucket[5m])) by (le)) > 5
        for: 5m
        labels:
          severity: warning
          team: ai
        annotations:
          summary: 'High AI request latency ({{ $value | humanizeDuration }})'
          description: '99th percentile AI request latency exceeds 5 seconds.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/AI_PERFORMANCE.md'
          impact: 'AI moves delayed, game experience impacted.'

      # -------------------------------------------------------------------------
      # AI Errors Increasing
      # -------------------------------------------------------------------------
      - alert: AIErrorsIncreasing
        expr: sum(rate(ringrift_ai_requests_total{outcome="error"}[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          team: ai
        annotations:
          summary: 'AI service errors increasing'
          description: |
            AI service is returning errors at a rate > 0.1/sec over the last 5 minutes.
            Correlate with game termination and fallback metrics (timeout, resignation,
            abandonment) via:
              - ringrift_game_session_abnormal_termination_total{reason=~"timeout|resignation|abandonment"}
              - ringrift_ai_fallback_total{reason=~"timeout|connection_refused|service_unavailable|overloaded"}
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/AI_ERRORS.md'
          impact: 'AI game experience degraded.'

      # -------------------------------------------------------------------------
      # Cluster Elo Divergence
      # -------------------------------------------------------------------------
      - alert: ClusterEloDivergence
        expr: ringrift_cluster_elo_divergence_max > 100
        for: 30m
        labels:
          severity: warning
          team: ai
          component: cluster
        annotations:
          summary: 'Cluster Elo ratings diverging (max diff: {{ $value | printf "%.0f" }})'
          description: 'Elo ratings between cluster nodes differ by more than 100 points. Run validate_cluster_elo.py --fix to sync.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/CLUSTER_ELO.md'
          impact: 'Model selection may be inconsistent across cluster nodes.'

      - alert: ClusterEloSourceUnreachable
        expr: ringrift_cluster_elo_source_reachable == 0
        for: 10m
        labels:
          severity: warning
          team: ai
          component: cluster
        annotations:
          summary: 'Authoritative Elo source (Mac Studio) unreachable'
          description: 'Cannot reach Mac Studio to validate Elo ratings. Cluster nodes may drift.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/CLUSTER_ELO.md'
          impact: 'Elo validation disabled, ratings may diverge.'

  # ===========================================================================
  # DEGRADATION ALERTS
  # ===========================================================================
  - name: degradation
    interval: 30s
    rules:
      # -------------------------------------------------------------------------
      # Service Degraded Mode
      # -------------------------------------------------------------------------
      - alert: ServiceDegraded
        expr: ringrift_degradation_level > 0
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Service operating in degraded mode (level {{ $value }})'
          description: |
            Service has been in degraded mode for more than 5 minutes.
            Level 1: DEGRADED - Some features unavailable
            Level 2: MINIMAL - Only core features available
            Level 3: OFFLINE - Service unavailable
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/SERVICE_DEGRADATION.md'
          impact: 'Some features may be unavailable to users.'

      # -------------------------------------------------------------------------
      # Service in Minimal Mode
      # -------------------------------------------------------------------------
      - alert: ServiceMinimalMode
        expr: ringrift_degradation_level >= 2
        for: 1m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'Service in minimal/offline mode (level {{ $value }})'
          description: 'Service is in minimal or offline mode. Only basic functionality available.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/SERVICE_DEGRADATION.md'
          impact: 'Most features unavailable, users significantly affected.'

      # -------------------------------------------------------------------------
      # Service Offline
      # -------------------------------------------------------------------------
      - alert: ServiceOffline
        expr: ringrift_degradation_level == 3
        for: 30s
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'Service is OFFLINE'
          description: 'Service has entered OFFLINE mode. All user-facing features are unavailable.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/SERVICE_OFFLINE.md'
          impact: 'Complete service outage.'

  # ===========================================================================
  # RATE LIMITING ALERTS
  # ===========================================================================
  - name: rate-limiting
    interval: 30s
    rules:
      # -------------------------------------------------------------------------
      # High Rate Limit Hits
      # -------------------------------------------------------------------------
      - alert: HighRateLimitHits
        expr: sum(rate(ringrift_rate_limit_hits_total[5m])) by (endpoint) > 1
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High rate limit hits on {{ $labels.endpoint }}'
          description: 'Rate limiting is being triggered frequently on endpoint {{ $labels.endpoint }}. This may indicate abuse or legitimate high traffic.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/RATE_LIMITING.md'
          impact: 'Some users may be experiencing rate limiting.'

      # -------------------------------------------------------------------------
      # Sustained Rate Limiting
      # -------------------------------------------------------------------------
      - alert: SustainedRateLimiting
        expr: sum(rate(ringrift_rate_limit_hits_total[15m])) > 10
        for: 15m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Sustained high rate limiting across endpoints'
          description: 'Rate limits are being hit frequently across multiple endpoints. Consider investigating traffic patterns.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/RATE_LIMITING.md'
          impact: 'Multiple users experiencing rate limiting.'

  # ===========================================================================
  # RULES PARITY ALERTS (Quality monitoring)
  # ===========================================================================
  - name: rules-parity
    interval: 60s
    rules:
      # -------------------------------------------------------------------------
      # Rules Validation Mismatch
      # -------------------------------------------------------------------------
      - alert: RulesParityValidationMismatch
        expr: increase(ringrift_rules_parity_mismatches_total{mismatch_type="validation"}[1h]) > 5
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'TS/Python rules validation mismatch detected'
          description: >
            More than 5 validation verdict mismatches (mismatch_type="validation")
            between TypeScript and Python rules engines in the last hour.
            Current suite={{ $labels.suite }}.
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/RULES_PARITY.md'
          impact: 'Rules parity issue may affect game integrity when switching engines.'

      # -------------------------------------------------------------------------
      # Rules State Hash Mismatch
      # -------------------------------------------------------------------------
      - alert: RulesParityHashMismatch
        expr: increase(ringrift_rules_parity_mismatches_total{mismatch_type="hash"}[1h]) > 5
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'TS/Python rules state hash mismatch detected'
          description: >
            More than 5 post-move state hash mismatches (mismatch_type="hash")
            between TypeScript and Python rules engines in the last hour.
            Current suite={{ $labels.suite }}.
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/RULES_PARITY.md'
          impact: 'Game state divergence possible between engines.'

      # -------------------------------------------------------------------------
      # Rules Game Status Mismatch
      # -------------------------------------------------------------------------
      - alert: RulesParityGameStatusMismatch
        expr: increase(ringrift_rules_parity_mismatches_total{mismatch_type="game_status"}[1h]) > 0
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'TS/Python rules game status mismatch'
          description: >
            One or more game status (win/loss/draw) mismatches (mismatch_type="game_status")
            between TypeScript and Python rules engines in the last hour.
            Current suite={{ $labels.suite }}.
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/RULES_PARITY.md'
          impact: 'Critical: Different game outcomes from different engines.'

  # ===========================================================================
  # PYTHON INVARIANT ALERTS (self-play / strict invariant soaks)
  # ===========================================================================
  - name: python-invariants
    interval: 60s
    rules:
      # -------------------------------------------------------------------------
      # Python Strict Invariant Violations (self-play soaks / AI service)
      # -------------------------------------------------------------------------
      - alert: PythonInvariantViolations
        expr: increase(ringrift_python_invariant_violations_total[1h]) > 0
        for: 5m
        labels:
          severity: warning
          team: ai
        annotations:
          summary: 'Python strict-invariant violation detected'
          description: >
            One or more Python self-play invariant violations were observed in the last hour
            (invariant_id={{ $labels.invariant_id }}, type={{ $labels.type }}).
            See docs/INVARIANTS_AND_PARITY_FRAMEWORK.md and docs/STRICT_INVARIANT_SOAKS.md
            for invariant ID semantics and operational guidance.
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STRICT_INVARIANT_SOAKS.md'
          impact: 'Potential divergence between Python self-play invariants and the TS orchestrator; may signal rules regressions affecting training.'
  # ===========================================================================
  # ORCHESTRATOR ROLLOUT ALERTS
  # ===========================================================================
  - name: orchestrator-rollout
    interval: 30s
    rules:
      # -----------------------------------------------------------------------
      # Circuit Breaker Opened
      # -----------------------------------------------------------------------
      - alert: OrchestratorCircuitBreakerOpen
        expr: ringrift_orchestrator_circuit_breaker_state == 1
        for: 30s
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'Orchestrator circuit breaker is OPEN'
          description: 'The orchestrator has been automatically disabled due to high error rate.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/ORCHESTRATOR_ROLLOUT_RUNBOOK.md'
          impact: 'All traffic using legacy engine. Requires manual investigation before increasing rollout again.'

      # -----------------------------------------------------------------------
      # High Orchestrator Error Rate (Warning)
      # -----------------------------------------------------------------------
      - alert: OrchestratorErrorRateWarning
        expr: ringrift_orchestrator_error_rate > 0.02
        for: 2m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Orchestrator error rate elevated ({{ $value | humanizePercentage }})'
          description: 'Orchestrator error rate is above 2%. Circuit may trip at 5% depending on configuration.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/ORCHESTRATOR_ROLLOUT_RUNBOOK.md'
          impact: 'Increased risk of moves failing on the orchestrator path; consider pausing rollout increases.'

      # -----------------------------------------------------------------------
      # Shadow Mode Mismatches (DEPRECATED)
      # NOTE: Shadow mode has been removed. FSM is now canonical.
      # This alert is retained for historical reference but will never fire
      # since the metric is no longer emitted.
      # -----------------------------------------------------------------------
      # - alert: OrchestratorShadowMismatches
      #   expr: ringrift_orchestrator_shadow_mismatch_rate > 0.01
      #   for: 5m
      #   labels:
      #     severity: warning
      #     team: backend
      #   annotations:
      #     summary: 'Orchestrator shadow mode showing mismatches'
      #     description: 'More than 1% of shadow comparisons show differences between engines. Investigate before increasing rollout.'
      #     runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/ORCHESTRATOR_ROLLOUT_RUNBOOK.md'
      #     impact: 'Potential semantic divergence between legacy and orchestrator engines.'

      # -----------------------------------------------------------------------
      # Orchestrator Invariant Violations – Staging
      # -----------------------------------------------------------------------
      - alert: OrchestratorInvariantViolationsStaging
        expr: increase(ringrift_orchestrator_invariant_violations_total[1h]) > 0
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Orchestrator invariant violation detected in staging'
          description: >
            One or more orchestrator-related invariant violations were observed in the last hour
            for invariant_id={{ $labels.invariant_id }} (type={{ $labels.type }}).
            Treat this as a staging SLO breach and block promotion until triaged.
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/ORCHESTRATOR_ROLLOUT_RUNBOOK.md'
          impact: 'Potential orchestrator rules or host integration defect discovered during staging or CI soaks.'

      # -----------------------------------------------------------------------
      # Orchestrator Invariant Violations – Production
      # -----------------------------------------------------------------------
      - alert: OrchestratorInvariantViolationsProduction
        expr: increase(ringrift_orchestrator_invariant_violations_total[1h]) > 0
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'Orchestrator invariant violation detected in production'
          description: >
            One or more orchestrator-related invariant violations were observed in the last hour
            for invariant_id={{ $labels.invariant_id }} (type={{ $labels.type }}).
            This indicates a violation of SLO-PROD-ORCH-INVARIANTS and should trigger an immediate
            rollout freeze and investigation.
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/ORCHESTRATOR_ROLLOUT_RUNBOOK.md'
          impact: 'Invariants violated under real player traffic; rules or host wiring may be producing illegal states.'

  # ===========================================================================
  # SERVICE RESPONSE TIME ALERTS
  # ===========================================================================
  - name: service-response
    interval: 30s
    rules:
      # -------------------------------------------------------------------------
      # Database Response Time High
      # -------------------------------------------------------------------------
      - alert: DatabaseResponseTimeSlow
        expr: histogram_quantile(0.99, sum(rate(ringrift_service_response_time_seconds_bucket{service="database"}[5m])) by (le)) > 0.5
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Database response time high ({{ $value | humanizeDuration }})'
          description: '99th percentile database query time exceeds 500ms.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/DATABASE_PERFORMANCE.md'
          impact: 'Slow database queries affecting request latency.'

      # -------------------------------------------------------------------------
      # Redis Response Time High
      # -------------------------------------------------------------------------
      - alert: RedisResponseTimeSlow
        expr: histogram_quantile(0.99, sum(rate(ringrift_service_response_time_seconds_bucket{service="redis"}[5m])) by (le)) > 0.1
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Redis response time high ({{ $value | humanizeDuration }})'
          description: '99th percentile Redis operation time exceeds 100ms.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/REDIS_PERFORMANCE.md'
          impact: 'Cache operations slow, affecting overall latency.'

  # ===========================================================================
  # CONNECTION & SESSION LIFECYCLE ALERTS
  # ===========================================================================
  - name: connection-lifecycle
    interval: 30s
    rules:
      # -------------------------------------------------------------------------
      # WebSocket reconnection timeouts (P18.3 decision/session lifecycle)
      # -------------------------------------------------------------------------
      - alert: WebSocketReconnectionTimeouts
        expr: sum(rate(ringrift_websocket_reconnection_total{result="timeout"}[5m])) > 0.05
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Elevated WebSocket reconnection timeouts'
          description: |
            Many players are failing to reconnect within the defined window. This corresponds to
            the reconnection semantics in P18.3-1_DECISION_LIFECYCLE_SPEC and the
            WebSocket reconnect behaviour exercised by the websocket-stress and player-moves
            k6 scenarios. See docs/ALERTING_THRESHOLDS.md#connection--session-lifecycle-alerts
            for SLO context.
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/WEBSOCKET_ISSUES.md'
          impact: 'Players may be losing games due to reconnection timeouts rather than gameplay outcomes.'

      # -------------------------------------------------------------------------
      # Abnormal game session termination spike
      # -------------------------------------------------------------------------
      - alert: AbnormalGameSessionTerminationSpike
        expr: |
          sum(
            rate(
              ringrift_game_session_abnormal_termination_total{
                reason=~"disconnect_timeout|internal_error|session_cleanup"
              }[10m]
            )
          ) > 0.02
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'Spike in abnormal game session terminations'
          description: |
            More games are ending via abnormal paths (disconnect timeouts, internal errors,
            forced cleanup) rather than normal victory conditions. See
            docs/ALERTING_THRESHOLDS.md#connection--session-lifecycle-alerts and
            docs/P18.3-1_DECISION_LIFECYCLE_SPEC.md for lifecycle semantics.
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/GAME_HEALTH.md'
          impact: 'Players may experience unexpected game terminations caused by infrastructure or lifecycle bugs.'

      # -------------------------------------------------------------------------
      # Game session status skew (no active turns/decision phases)
      # -------------------------------------------------------------------------
      - alert: GameSessionStatusSkew
        expr: |
          sum(ringrift_game_session_status_current{status=~"active_decision_phase|active_turn"}) == 0
          and sum(ringrift_game_session_status_current) > 0
        for: 15m
        labels:
          severity: info
          team: backend
        annotations:
          summary: 'All in-memory sessions stuck in non-active states'
          description: |
            There are live game sessions but none in active_turn or active_decision_phase states.
            This may indicate stuck timers, unresolved decision phases, or reconnection edge cases.
            See docs/ALERTING_THRESHOLDS.md#connection--session-lifecycle-alerts and
            docs/P18.3-1_DECISION_LIFECYCLE_SPEC.md for the canonical session state machine.
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/GAME_HEALTH.md'
          impact: 'Games may be stalled in waiting/cleanup states even though players are connected.'

  # ===========================================================================
  # STAGING SLO ALERTS (Production Validation)
  # ===========================================================================
  # These alerts are specifically tuned for the staging environment to validate
  # production SLOs before deployment. Targets from PROJECT_GOALS.md:
  # - 100 concurrent games, 300 concurrent players
  # - <500ms p95 latency
  # - <1% error rate
  # - >99.9% uptime
  # ===========================================================================
  - name: staging-slos
    interval: 15s
    rules:
      # -------------------------------------------------------------------------
      # Staging P95 Latency SLO (500ms target)
      # -------------------------------------------------------------------------
      - alert: StagingHighLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 0.5
        for: 2m
        labels:
          severity: warning
          environment: staging
          slo: latency
        annotations:
          summary: 'Staging p95 latency exceeding 500ms SLO ({{ $value | humanizeDuration }})'
          description: 'P95 latency is {{ $value | humanizeDuration }}, exceeding the 500ms production SLO target. This would fail production validation.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#high-latency-during-load-tests'
          impact: 'Production SLO would be breached. Investigate before promoting to production.'

      - alert: StagingCriticalLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
        for: 1m
        labels:
          severity: critical
          environment: staging
          slo: latency
        annotations:
          summary: 'Staging p95 latency critically high ({{ $value | humanizeDuration }})'
          description: 'P95 latency is {{ $value | humanizeDuration }}, double the 500ms production SLO target.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#high-latency-during-load-tests'
          impact: 'System is not production-ready. Block deployment until resolved.'

      # -------------------------------------------------------------------------
      # Staging Error Rate SLO (1% target)
      # -------------------------------------------------------------------------
      - alert: StagingHighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.01
        for: 1m
        labels:
          severity: critical
          environment: staging
          slo: error_rate
        annotations:
          summary: 'Staging error rate exceeding 1% SLO ({{ $value | humanizePercentage }})'
          description: 'Error rate is {{ $value | humanizePercentage }}, exceeding the 1% production SLO target.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#troubleshooting'
          impact: 'Production SLO would be breached. Investigate errors before promoting.'

      - alert: StagingElevatedErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.005
        for: 5m
        labels:
          severity: warning
          environment: staging
          slo: error_rate
        annotations:
          summary: 'Staging error rate elevated ({{ $value | humanizePercentage }})'
          description: 'Error rate is {{ $value | humanizePercentage }}, approaching the 1% production SLO limit.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#troubleshooting'
          impact: 'System is at risk of breaching SLO under increased load.'

      # -------------------------------------------------------------------------
      # Staging AI Service SLO (1s move latency, <30% fallback)
      # -------------------------------------------------------------------------
      - alert: StagingAILatencyHigh
        expr: histogram_quantile(0.95, sum(rate(ringrift_ai_request_duration_seconds_bucket[5m])) by (le)) > 1
        for: 2m
        labels:
          severity: warning
          environment: staging
          slo: ai_latency
        annotations:
          summary: 'Staging AI move latency exceeding 1s SLO'
          description: 'AI move p95 latency is {{ $value | humanizeDuration }}, exceeding the 1s production target.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#ai-service-not-responding'
          impact: 'AI-controlled games would feel sluggish in production.'

      - alert: StagingAIFallbackHigh
        expr: |
          (
            sum(rate(ringrift_ai_fallback_total[5m]))
            /
            (sum(rate(ringrift_ai_requests_total[5m])) > 0)
          ) > 0.3
        for: 5m
        labels:
          severity: warning
          environment: staging
          slo: ai_availability
        annotations:
          summary: 'Staging AI fallback rate high ({{ $value | humanizePercentage }})'
          description: 'More than 30% of AI requests are falling back to local heuristics.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#ai-service-not-responding'
          impact: 'AI move quality degraded. Investigate AI service capacity.'

      # -------------------------------------------------------------------------
      # Staging Capacity Alerts (100 games / 300 players target)
      # -------------------------------------------------------------------------
      - alert: StagingApproachingGameCapacity
        expr: ringrift_games_active > 80
        for: 5m
        labels:
          severity: info
          environment: staging
          slo: capacity
        annotations:
          summary: 'Staging approaching 100 game capacity ({{ $value }} active)'
          description: 'Active games: {{ $value }}. Approaching the 100 concurrent games target for production validation.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#load-testing'
          impact: 'Nearing capacity limits. Monitor for performance degradation.'

      - alert: StagingApproachingConnectionCapacity
        expr: ringrift_websocket_connections > 250
        for: 5m
        labels:
          severity: info
          environment: staging
          slo: capacity
        annotations:
          summary: 'Staging approaching 300 connection capacity ({{ $value }} connected)'
          description: 'WebSocket connections: {{ $value }}. Approaching the 300 concurrent players target.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#load-testing'
          impact: 'Nearing connection limits. Monitor for WebSocket issues.'

      - alert: StagingExceedingCapacity
        expr: ringrift_games_active > 120 or ringrift_websocket_connections > 350
        for: 2m
        labels:
          severity: warning
          environment: staging
          slo: capacity
        annotations:
          summary: 'Staging exceeding target capacity'
          description: 'Games: {{ with query "ringrift_games_active" }}{{ . | first | value }}{{ end }}, Connections: {{ with query "ringrift_websocket_connections" }}{{ . | first | value }}{{ end }}. Exceeding 100 games / 300 players target.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#load-testing'
          impact: 'Stress testing territory. Monitor for system stability.'

      # -------------------------------------------------------------------------
      # Staging Resource Alerts
      # -------------------------------------------------------------------------
      - alert: StagingHighMemoryUsage
        expr: sum(container_memory_usage_bytes{name=~".*app.*"}) / 1024 / 1024 / 1024 > 0.8
        for: 5m
        labels:
          severity: warning
          environment: staging
        annotations:
          summary: 'Staging app memory usage high ({{ $value | printf "%.2f" }}GB)'
          description: 'Application container memory is approaching the 1GB limit.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#troubleshooting'
          impact: 'Risk of OOM under sustained load.'

      - alert: StagingDatabaseConnectionsHigh
        expr: pg_stat_activity_count > 150
        for: 5m
        labels:
          severity: warning
          environment: staging
        annotations:
          summary: 'Staging database connections high ({{ $value }}/200)'
          description: 'PostgreSQL connection count approaching the 200 max_connections limit.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md#troubleshooting'
          impact: 'Connection pool may be exhausted under higher load.'

      # -------------------------------------------------------------------------
      # Staging Load Test Progress
      # -------------------------------------------------------------------------
      - alert: StagingLoadTestValidationPassed
        expr: |
          (
            histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) < 0.5
            and
            (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) < 0.01
            and
            ringrift_games_active >= 50
          )
        for: 10m
        labels:
          severity: info
          environment: staging
          slo: validation
        annotations:
          summary: 'Staging SLOs passing under load'
          description: 'System is meeting production SLOs with {{ with query "ringrift_games_active" }}{{ . | first | value }}{{ end }} active games. p95 latency and error rate within targets.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/STAGING_ENVIRONMENT.md'
          impact: 'Positive signal for production readiness (continue monitoring).'

  # ===========================================================================
  # DATA QUALITY ALERTS
  # ===========================================================================
  - name: data_quality
    interval: 60s
    rules:
      # -------------------------------------------------------------------------
      # High Draw Rate - Warning
      # -------------------------------------------------------------------------
      - alert: DataQualityHighDrawRate
        expr: ringrift_data_draw_rate > 0.15
        for: 5m
        labels:
          severity: warning
          team: ai
          component: training-data
        annotations:
          summary: 'High draw rate in training data ({{ $value | humanizePercentage }})'
          description: 'Draw rate in database {{ $labels.db_name }} exceeds 15%. This may indicate games timing out or other data quality issues.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/DATA_QUALITY.md'
          impact: 'Training data may be contaminated with timeout games, degrading model quality.'

      # -------------------------------------------------------------------------
      # Games Hitting Move Limit - Critical
      # -------------------------------------------------------------------------
      - alert: DataQualityTimeoutGames
        expr: ringrift_data_games_at_limit > 0
        for: 1m
        labels:
          severity: critical
          team: ai
          component: training-data
        annotations:
          summary: 'Timeout games detected in training data ({{ $value }} games at limit {{ $labels.limit }})'
          description: 'Database {{ $labels.db_name }} contains {{ $value }} games that hit the {{ $labels.limit }} move limit. These are likely timeout games that should be filtered.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/DATA_QUALITY.md#timeout-games'
          impact: 'Training data contamination will degrade model performance. Run filter_timeout_games.py immediately.'

      # -------------------------------------------------------------------------
      # Low Quality Score
      # -------------------------------------------------------------------------
      - alert: DataQualityLowScore
        expr: ringrift_data_quality_score < 80
        for: 5m
        labels:
          severity: warning
          team: ai
          component: training-data
        annotations:
          summary: 'Low data quality score for {{ $labels.db_name }} ({{ $value }}/100)'
          description: 'Quality score for database {{ $labels.db_name }} is below 80. Check for contamination, duplicate games, or schema issues.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/DATA_QUALITY.md'
          impact: 'Training on low-quality data may produce suboptimal models.'

      # -------------------------------------------------------------------------
      # Suspicious High Move Count
      # -------------------------------------------------------------------------
      - alert: DataQualitySuspiciousGames
        expr: ringrift_data_games_high_moves > 100
        for: 5m
        labels:
          severity: warning
          team: ai
          component: training-data
        annotations:
          summary: 'Suspicious high-move games detected ({{ $value }} games > 1000 moves)'
          description: 'Database {{ $labels.db_name }} contains {{ $value }} games with unusually high move counts. These may indicate infinite loops or timeout conditions.'
          runbook_url: 'https://github.com/ringrift/ringrift/blob/main/docs/runbooks/DATA_QUALITY.md'
          impact: 'Potential data quality issue affecting training.'
