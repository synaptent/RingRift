groups:
  - name: ringrift-ai-alerts
    rules:
      # Elo Regression Alert
      - alert: EloRegression
        expr: |
          (
            max_over_time(ringrift_best_elo[1h]) - ringrift_best_elo
          ) > 50
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Elo regression detected for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Best Elo dropped by more than 50 points in the last hour. Current: {{ $value | printf "%.1f" }}'

      # Training Stalled
      - alert: TrainingStalled
        expr: |
          time() - ringrift_last_training_time > 7200
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: 'Training stalled for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'No training completed in the last 2 hours'

      # Low Game Generation
      - alert: LowGameGeneration
        expr: |
          ringrift_games_per_hour < 10
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Low game generation for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Game generation rate dropped below 10 games/hour: {{ $value | printf "%.1f" }}'

      # High Training Loss
      - alert: HighTrainingLoss
        expr: |
          ringrift_training_loss > 2.0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'High training loss for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Training loss is unusually high: {{ $value | printf "%.3f" }}'

      # Node Down
      - alert: NodeDown
        expr: |
          ringrift_node_alive == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'Cluster node {{ $labels.node }} is down'
          description: 'Node has been unreachable for 5 minutes'

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: |
          ringrift_memory_percent > 90
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: 'High memory usage on {{ $labels.node }}'
          description: 'Memory usage is {{ $value | printf "%.1f" }}%'

      # GPU Memory Full
      - alert: GPUMemoryFull
        expr: |
          ringrift_gpu_memory_percent > 95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'GPU memory nearly full on {{ $labels.node }}'
          description: 'GPU memory usage is {{ $value | printf "%.1f" }}%'

      # Stale Training Data
      - alert: StaleTrainingData
        expr: |
          ringrift_data_freshness_hours > 6
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Training data is stale for {{ $labels.config }}'
          description: 'Newest training data is {{ $value | printf "%.1f" }} hours old'

      # Improvement Loop Stuck
      - alert: ImprovementLoopStuck
        expr: |
          increase(ringrift_improvement_cycles_total[6h]) == 0
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Improvement loop appears stuck'
          description: 'No improvement cycles completed in the last 6 hours'

      # Promotion Failures
      - alert: HighPromotionFailures
        expr: |
          ringrift_promotion_success_rate < 0.2
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: 'High promotion failure rate'
          description: 'Model promotion success rate is only {{ $value | printf "%.1f" }}%'

      # Opening Diversity Drop
      - alert: LowOpeningDiversity
        expr: |
          ringrift_opening_diversity < 10
        for: 2h
        labels:
          severity: info
        annotations:
          summary: 'Low opening diversity for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Only {{ $value }} unique openings seen - may indicate collapsed search'

      # Overfitting Detected
      - alert: OverfitDetected
        expr: |
          ringrift_overfit_gap > 0.15
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Overfitting detected for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Holdout loss exceeds training loss by {{ $value | printf "%.3f" }} - model may be overfitting'

      # Low Holdout Accuracy
      - alert: LowHoldoutAccuracy
        expr: |
          ringrift_holdout_accuracy < 0.70
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Low holdout accuracy for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Holdout accuracy is {{ $value | printf "%.1f" }}% - model generalization may be poor'

      # Insufficient Holdout Data
      - alert: InsufficientHoldoutData
        expr: |
          ringrift_holdout_games < 100
        for: 24h
        labels:
          severity: info
        annotations:
          summary: 'Insufficient holdout data for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Only {{ $value }} holdout games available - need more data for reliable overfitting detection'

      # MCTS Search Quality
      - alert: LowMCTSSearchDepth
        expr: |
          ringrift_mcts_avg_depth < 3
        for: 1h
        labels:
          severity: info
        annotations:
          summary: 'Low MCTS search depth detected'
          description: 'Average search depth is only {{ $value | printf "%.1f" }} - may indicate resource constraints or slow evaluation'

      # Data Quality Issues
      - alert: HighShortGameRate
        expr: |
          ringrift_data_quality_short_rate > 15
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: 'High short game rate for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: '{{ $value | printf "%.1f" }}% of games are under 10 moves - may indicate degenerate training data'

      - alert: DataQualityIssuesDetected
        expr: |
          ringrift_data_quality_issues > 3
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Multiple data quality issues detected'
          description: '{{ $value }} data quality issues found - check /data/quality/issues endpoint'

      # Training Efficiency
      - alert: LowTrainingEfficiency
        expr: |
          ringrift_elo_per_gpu_hour < 0.5
        for: 6h
        labels:
          severity: info
        annotations:
          summary: 'Low training efficiency for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Only {{ $value | printf "%.2f" }} Elo/GPU-hour - consider adjusting hyperparameters'

      - alert: HighTrainingCost
        expr: |
          ringrift_training_cost_usd > 100
        for: 1h
        labels:
          severity: info
        annotations:
          summary: 'High training cost for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Estimated cost is ${{ $value | printf "%.2f" }} - monitor for budget'

      # Rollback Recommendations
      - alert: RollbackRecommended
        expr: |
          ringrift_rollback_candidates > 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Model rollback recommended'
          description: '{{ $value }} config(s) have rollback recommendations - check /rollback/status'

      # Autoscaling
      - alert: LowClusterThroughput
        expr: |
          ringrift_cluster_games_per_hour < 20
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: 'Low cluster throughput'
          description: 'Only {{ $value | printf "%.0f" }} games/hour - consider scaling up workers'

      - alert: ScaleUpRecommended
        expr: |
          ringrift_autoscale_suggested_workers > (count(ringrift_node_alive == 1) + 1)
        for: 1h
        labels:
          severity: info
        annotations:
          summary: 'Scale-up recommended'
          description: 'Autoscaler suggests {{ $value }} workers - current cluster may be undersized'
