// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String
  role          UserRole  @default(USER)
  rating        Int       @default(1200)
  gamesPlayed   Int       @default(0)
  gamesWon      Int       @default(0)
  emailVerified Boolean   @default(false)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Auth tokens
  verificationToken        String?
  verificationTokenExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?

  // Game relationships
  gamesAsPlayer1 Game[] @relation("Player1")
  gamesAsPlayer2 Game[] @relation("Player2")
  gamesAsPlayer3 Game[] @relation("Player3")
  gamesAsPlayer4 Game[] @relation("Player4")
  gamesWonGames  Game[] @relation("Winner")
  moves          Move[]
  refreshTokens  RefreshToken[]

  @@map("users")
}

model Game {
  id              String     @id @default(cuid())
  boardType       BoardType
  maxPlayers      Int
  timeControl     Json // { initialTime: number, increment: number }
  isRated         Boolean    @default(true)
  allowSpectators Boolean    @default(true)
  status          GameStatus @default(waiting)
  gameState       Json       @default("{}")

  // Players
  player1Id String?
  player1   User?   @relation("Player1", fields: [player1Id], references: [id])
  player2Id String?
  player2   User?   @relation("Player2", fields: [player2Id], references: [id])
  player3Id String?
  player3   User?   @relation("Player3", fields: [player3Id], references: [id])
  player4Id String?
  player4   User?   @relation("Player4", fields: [player4Id], references: [id])

  // Game result
  winnerId String?
  winner   User?   @relation("Winner", fields: [winnerId], references: [id])

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  startedAt DateTime?
  endedAt   DateTime?

  // Related data
  moves Move[]

  @@map("games")
}

model Move {
  id         String   @id @default(cuid())
  gameId     String
  game       Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerId   String
  player     User     @relation(fields: [playerId], references: [id])
  moveNumber Int
  position   Json // { x: number, y: number } or { q: number, r: number, s: number } for hex
  moveType   MoveType
  timestamp  DateTime @default(now())

  @@unique([gameId, moveNumber])
  @@map("moves")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum BoardType {
  square8
  square19
  hexagonal
}

enum GameStatus {
  waiting
  active
  completed
  cancelled
  paused
  abandoned
  finished
}

enum MoveType {
  place_ring
  move_ring
  build_stack
  move_stack
  overtaking_capture
  line_formation
  territory_claim
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}
