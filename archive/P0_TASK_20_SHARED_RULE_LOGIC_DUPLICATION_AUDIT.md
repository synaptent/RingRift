# P0 Task 20 – Shared Rule Logic Duplication Audit

## 1. Overview

This document audits remaining **rules-logic duplication** between:

- The **backend host engine** under [`src/server/game`](src/server/game/GameEngine.ts:1),
- The **client sandbox engine** under [`src/client/sandbox`](src/client/sandbox/ClientSandboxEngine.ts:1),

relative to the **canonical shared rules engine** under [`src/shared/engine`](src/shared/engine/GameEngine.ts:1).

Per [`RULES_ENGINE_ARCHITECTURE.md`](RULES_ENGINE_ARCHITECTURE.md:1), the intended design is:

- All **core rules semantics** (geometry, legality, and state mutations) live in shared helpers:
  - Movement & captures in [`core.ts`](src/shared/engine/core.ts:1), [`movementLogic.ts`](src/shared/engine/movementLogic.ts:1), [`captureLogic.ts`](src/shared/engine/captureLogic.ts:1),
    [`MovementValidator.ts`](src/shared/engine/validators/MovementValidator.ts:1), [`CaptureValidator.ts`](src/shared/engine/validators/CaptureValidator.ts:1),
    [`MovementMutator.ts`](src/shared/engine/mutators/MovementMutator.ts:1), [`CaptureMutator.ts`](src/shared/engine/mutators/CaptureMutator.ts:1).
  - Lines in [`lineDetection.ts`](src/shared/engine/lineDetection.ts:1), [`LineValidator.ts`](src/shared/engine/validators/LineValidator.ts:1),
    [`LineMutator.ts`](src/shared/engine/mutators/LineMutator.ts:1).
  - Territory in [`territoryDetection.ts`](src/shared/engine/territoryDetection.ts:1), [`territoryBorders.ts`](src/shared/engine/territoryBorders.ts:1),
    [`territoryProcessing.ts`](src/shared/engine/territoryProcessing.ts:1), [`TerritoryValidator.ts`](src/shared/engine/validators/TerritoryValidator.ts:1),
    [`TerritoryMutator.ts`](src/shared/engine/mutators/TerritoryMutator.ts:1).
  - Placement in [`PlacementValidator.ts`](src/shared/engine/validators/PlacementValidator.ts:1),
    [`PlacementMutator.ts`](src/shared/engine/mutators/PlacementMutator.ts:1).
  - Victory & structural stalemate in [`victoryLogic.ts`](src/shared/engine/victoryLogic.ts:1).
  - Turn/phase sequencing in [`turnLogic.ts`](src/shared/engine/turnLogic.ts:1) and [`TurnMutator.ts`](src/shared/engine/mutators/TurnMutator.ts:1).

- Backend [`GameEngine`](src/server/game/GameEngine.ts:1) + [`RuleEngine`](src/server/game/RuleEngine.ts:1) and client [`ClientSandboxEngine`](src/client/sandbox/ClientSandboxEngine.ts:1) should act as **thin hosts/adapters**, delegating rule semantics to shared helpers.

This audit catalogs, per concern, where the backend and sandbox:

- Fully delegate to shared helpers,
- Add only thin glue/adapters, or
- Still **re-implement** core rules logic (true duplication).

The goal is to inform **Subtask #6 (“Design shared helper modules for remaining turn actions”)**, not to change runtime behaviour in this step.

---

## 2. Movement & Captures

### 2.1 Movement

| Area                                                                                       | Shared canonical helper(s)                                                                                                                                                                                | Backend code paths still implementing logic                                                                                                                                                                                                                                                                                                              | Sandbox code paths still implementing logic                                                                                                                                                                                                                                                                                | Status                            | Notes                                                                                                                                                                                                                                                                             |
| ------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Non-capturing movement target enumeration from a stack                                     | [`movementLogic.enumerateSimpleMoveTargetsFromStack()`](src/shared/engine/movementLogic.ts:1)                                                                                                             | [`RuleEngine.getValidStackMovements()`](src/server/game/RuleEngine.ts:916) builds a `MovementBoardView` and forwards to the shared enumerator.                                                                                                                                                                                                           | [`sandboxMovement.enumerateSimpleMovementLandings()`](src/client/sandbox/sandboxMovement.ts:23) builds a `MovementBoardView` and forwards to the shared enumerator.                                                                                                                                                        | **Thin adapter**                  | Enumeration geometry (directions, distance ≥ stackHeight, path blocking, marker/stack landing rules) is fully defined in the shared engine; hosts only provide board accessors.                                                                                                   |
| Per-move geometric/path legality for simple moves                                          | [`MovementValidator.validateMovement()`](src/shared/engine/validators/MovementValidator.ts:1)                                                                                                             | [`RuleEngine.validateStackMovement()`](src/server/game/RuleEngine.ts:193) re-validates by recomputing targets via `enumerateSimpleMoveTargetsFromStack()` and checking membership; does **not** call `MovementValidator`.                                                                                                                                | [`sandboxMovementEngine.handleMovementClickSandbox()`](src/client/sandbox/sandboxMovementEngine.ts:120) re-derives legality via `getPathPositions()`, `calculateDistance()`, path-blocking and marker rules instead of delegating to `MovementValidator`.                                                                  | **Duplicated (validation shape)** | All three rely on the same underlying geometry helpers, but per-move legality is implemented three times (shared validator, backend, sandbox). Backend/sandbox are logically aligned today but could drift if shared validator changes.                                           |
| Movement application (stack merge/move, marker effects, landing-on-own-marker elimination) | [`MovementMutator.mutateMovement()`](src/shared/engine/mutators/MovementMutator.ts:1), [`core.applyMarkerEffectsAlongPathOnBoard()`](src/shared/engine/core.ts:1)                                         | [`GameEngine.applyMove()`](src/server/game/GameEngine.ts:825) branch for `'move_ring'/'move_stack'` plus [`GameEngine.processMarkersAlongPath()`](src/server/game/GameEngine.ts:2153) directly mutate stacks/markers and perform landing-on-own-marker elimination.                                                                                      | [`sandboxMovementEngine.handleMovementClickSandbox()`](src/client/sandbox/sandboxMovementEngine.ts:120) + `applyMarkerEffectsAlongPathWithHooks()` and elimination logic, with additional landing-on-own-marker elimination in [`handleMovementClickSandbox()`](src/client/sandbox/sandboxMovementEngine.ts:255).          | **Duplicated (mutators)**         | Both hosts implement their own movement mutators and marker-path effects, re-encoding semantics that already exist in `MovementMutator` + shared marker helpers. They _do_ use `applyMarkerEffectsAlongPathOnBoard()` but not the shared movement mutator.                        |
| “Has any legal move or capture from stack” (reachability / no-dead-placement)              | [`core.hasAnyLegalMoveOrCaptureFromOnBoard()`](src/shared/engine/core.ts:1)                                                                                                                               | [`RuleEngine.hasAnyLegalMoveOrCaptureFrom()`](src/server/game/RuleEngine.ts:1439) is a thin adapter over the shared helper; used by [`RuleEngine.validateSkipPlacement()`](src/server/game/RuleEngine.ts:107) and placement enumeration.                                                                                                                 | [`sandboxPlacement.hasAnyLegalMoveOrCaptureFrom()`](src/client/sandbox/sandboxPlacement.ts:85) is a thin adapter over `hasAnyLegalMoveOrCaptureFromOnBoard()`. [`ClientSandboxEngine.hasAnyLegalMoveOrCaptureFrom()`](src/client/sandbox/ClientSandboxEngine.ts:653) wraps the same helper for sandbox AI/placement flows. | **Fully shared / thin wrappers**  | Reachability semantics for “any move or capture from this stack” are cleanly centralised; both hosts correctly delegate to the shared helper.                                                                                                                                     |
| Phase-level “has valid movements” turn-gating                                              | [`core.hasAnyLegalMoveOrCaptureFromOnBoard()`](src/shared/engine/core.ts:1) and [`movementLogic.enumerateSimpleMoveTargetsFromStack()`](src/shared/engine/movementLogic.ts:1) are the intended primitives | [`GameEngine.hasValidMovements()`](src/server/game/GameEngine.ts:2314) implements its own ray-walk/BFS over directions using `getAllDirections()` and manual distance/path checks; used by [`GameEngine.hasValidActions()`](src/server/game/GameEngine.ts:2286) and ultimately by the server turn engine delegates (`hasAnyMovement` / `hasAnyCapture`). | [`sandboxTurnEngine.maybeProcessForcedEliminationForCurrentPlayerSandbox()`](src/client/sandbox/sandboxTurnEngine.ts:228) asks `hooks.hasAnyLegalMoveOrCaptureFrom(...)`, which in `ClientSandboxEngine` is wired to `hasAnyLegalMoveOrCaptureFromOnBoard()`.                                                              | **Duplicated (backend only)**     | Backend still uses a legacy approximate movement search for turn-gating, separate from the shared reachability helper that drives actual move enumeration. Sandbox gating is fully shared; backend gating is the main remaining duplication/risk in movement availability checks. |

### 2.2 Captures

| Area                                                                                         | Shared canonical helper(s)                                                                                                                                        | Backend code paths still implementing logic                                                                                                                                                                                                                                                                                                                                               | Sandbox code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                                                                         | Status                        | Notes                                                                                                                                                                                                                                                     |
| -------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Single capture segment validation (from/target/landing)                                      | [`core.validateCaptureSegmentOnBoard()`](src/shared/engine/core.ts:1), [`CaptureValidator.validateCapture()`](src/shared/engine/validators/CaptureValidator.ts:1) | [`RuleEngine.validateCaptureSegment()`](src/server/game/RuleEngine.ts:341) builds a `CaptureSegmentBoardView` and delegates to `validateCaptureSegmentOnBoard()`. [`RuleEngine.validateCapture()`](src/server/game/RuleEngine.ts:277) calls this helper.                                                                                                                                  | [`sandboxMovementEngine.handleMovementClickSandbox()`](src/client/sandbox/sandboxMovementEngine.ts:191) builds a `CaptureSegmentBoardView` and delegates to `validateCaptureSegmentOnBoard()` for candidate segments.                                                                                                                                                                                                                                               | **Thin adapter**              | Segment-level legality (directions, distance, cap-height comparison, landing constraints) is consistently delegated to shared helpers; hosts only provide board views.                                                                                    |
| Capture move enumeration from a stack                                                        | [`captureLogic.enumerateCaptureMoves()`](src/shared/engine/captureLogic.ts:1)                                                                                     | [`RuleEngine.getValidCaptures()`](src/server/game/RuleEngine.ts:976) adapts the board to `CaptureBoardAdapters` and calls the shared enumerator, then wraps results as `Move`s. [`captureChainEngine.getCaptureOptionsFromPosition()`](src/server/game/rules/captureChainEngine.ts:86) does the same for chain-continuation options.                                                      | [`sandboxCaptures.enumerateCaptureSegmentsFromBoard()`](src/client/sandbox/sandboxCaptures.ts:37) feeds a board adapter into `enumerateCaptureMovesShared()`. [`sandboxMovementEngine.enumerateCaptureSegmentsFromSandbox()`](src/client/sandbox/sandboxMovementEngine.ts:553) reuses the same helper.                                                                                                                                                              | **Thin adapter**              | Capture enumeration is fully centralised; both backend and sandbox are now thin adapters over the shared enumerator.                                                                                                                                      |
| Capture application (markers + overtaking ring transfer + landing-on-own-marker elimination) | [`CaptureMutator.mutateCapture()`](src/shared/engine/mutators/CaptureMutator.ts:1), [`core.applyMarkerEffectsAlongPathOnBoard()`](src/shared/engine/core.ts:1)    | [`GameEngine.performOvertakingCapture()`](src/server/game/GameEngine.ts:1051) directly manipulates stacks and markers, then applies landing-on-own-marker elimination via [`GameEngine.eliminateTopRingAt()`](src/server/game/GameEngine.ts:1929). Marker-path effects are handled via [`GameEngine.processMarkersAlongPath()`](src/server/game/GameEngine.ts:2153).                      | [`sandboxCaptures.applyCaptureSegmentOnBoard()`](src/client/sandbox/sandboxCaptures.ts:98) handles board mutation for a capture segment (including marker-path calls via adapters and ring transfer). Landing-on-own-marker elimination is performed in [`sandboxMovementEngine.applyCaptureSegmentWithHooks()`](src/client/sandbox/sandboxMovementEngine.ts:574) and [`ClientSandboxEngine.applyCaptureSegment()`](src/client/sandbox/ClientSandboxEngine.ts:701). | **Duplicated (mutators)**     | Both hosts directly re-encode capture mutator semantics instead of calling `CaptureMutator.mutateCapture()`. They _do_ consistently use `applyMarkerEffectsAlongPathOnBoard()` but own the overtaking/landing bookkeeping and ring-elimination deltas.    |
| Capture chain state machine & `chain_capture` phase                                          | _(No dedicated shared-chain helper; shared engine exposes only per-segment logic.)_                                                                               | [`captureChainEngine.updateChainCaptureStateAfterCapture()`](src/server/game/rules/captureChainEngine.ts:45), [`captureChainEngine.getCaptureOptionsFromPosition()`](src/server/game/rules/captureChainEngine.ts:86), and [`GameEngine.updateChainCaptureStateAfterCapture()`](src/server/game/GameEngine.ts:1004) model `ChainCaptureState` and drive `chain_capture` phase transitions. | [`sandboxMovementEngine.performCaptureChainSandbox()`](src/client/sandbox/sandboxMovementEngine.ts:400) runs a local chain loop over `enumerateCaptureSegmentsFromSandbox()`, with optional `chooseCaptureSegment` interaction. `ClientSandboxEngine.performCaptureChain()` wraps this for tests.                                                                                                                                                                   | **Host-specific but aligned** | Chain-capture orchestration (multi-segment chains, phase handling) is intentionally host-level, built on shared per-segment validation and enumeration. Both hosts implement equivalent state machines but there is no canonical shared-chain module yet. |

---

## 3. Lines (Detection & Processing)

| Area                                                                                   | Shared canonical helper(s)                                                                                                                                                                                                                                                                                     | Backend code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Sandbox code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                        | Status                            | Notes                                                                                                                                                                                                                                                                                                   |
| -------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Marker-line detection (geometry and min-length filtering)                              | [`lineDetection.findAllLines()`](src/shared/engine/lineDetection.ts:1)                                                                                                                                                                                                                                         | [`BoardManager.findAllLines()`](src/server/game/BoardManager.ts:749) delegates directly to `findAllLinesShared()`. [`BoardManager.findLinesFromPosition()`](src/server/game/BoardManager.ts:604) filters `findLinesForPlayerShared()`. Old geometry helpers (`getLineDirections()`, `findLineInDirection()`) are retained only for debug.                                                                                                                                                                                                                                                                 | [`sandboxLines.findAllLinesOnBoard()`](src/client/sandbox/sandboxLines.ts:124) is a thin adapter over `findAllLinesShared()`, ignoring its legacy geometry parameters.                                                                                                                                                                                                                                             | **Fully shared**                  | Line detection geometry is single-sourced in the shared engine; all host-facing `findAllLines*` wrappers simply forward to it.                                                                                                                                                                          |
| Line-processing decision move enumeration (`process_line` / `choose_line_reward`)      | [`LineValidator.validateProcessLine()`](src/shared/engine/validators/LineValidator.ts:1), [`LineValidator.validateChooseLineReward()`](src/shared/engine/validators/LineValidator.ts:1) + [`LineMutator`](src/shared/engine/mutators/LineMutator.ts:1) for semantics (no shared decision-move enumerator yet). | [`GameEngine.getValidLineProcessingMoves()`](src/server/game/GameEngine.ts:1190) scans `BoardManager.findAllLines()`, synthesises `process_line` and `choose_line_reward` moves (including implicit Option 1/2 IDs), and is used from `getValidMoves()` for `line_processing`. [`RuleEngine.getValidLineProcessingDecisionMoves()`](src/server/game/RuleEngine.ts:1076) duplicates similar enumeration for stateless rules tests.                                                                                                                                                                         | [`sandboxLinesEngine.getValidLineProcessingMoves()`](src/client/sandbox/sandboxLinesEngine.ts:143) re-implements the same enumeration over `findAllLinesOnBoard()`. [`ClientSandboxEngine.getValidLineProcessingMovesForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:1569) adds another variation oriented around sandbox history and trace mode.                                                   | **Duplicated (enumeration)**      | There are **three independent decision-move enumerators** for lines (backend GameEngine, backend RuleEngine, sandbox), all based on shared detection but not sharing enumeration code. Semantics are currently aligned but maintenance cost and drift risk are high.                                    |
| Line reward resolution, marker collapse, and ring/cap elimination (automatic pipeline) | [`LineMutator.mutateProcessLine()`](src/shared/engine/mutators/LineMutator.ts:1), [`LineMutator.mutateChooseLineReward()`](src/shared/engine/mutators/LineMutator.ts:1)                                                                                                                                        | Legacy inline implementation in [`GameEngine.processLineFormations()`](src/server/game/GameEngine.ts:1709), [`GameEngine.processOneLine()`](src/server/game/GameEngine.ts:1767), [`GameEngine.collapseLineMarkers()`](src/server/game/GameEngine.ts:1831), and elimination helpers (`eliminatePlayerRingOrCap*`, `eliminateFromStack()`) remains, but **current automatic pipeline** delegates to [`rules/lineProcessing.processLinesForCurrentPlayer()`](src/server/game/rules/lineProcessing.ts:30), which itself re-implements collapse + elimination using `BoardManager` and `calculateCapHeight()`. | [`sandboxLinesEngine.processLinesForCurrentPlayer()`](src/client/sandbox/sandboxLinesEngine.ts:326) implements its own loop over `findAllLinesOnBoard()`, `collapseLineMarkersOnBoard()`, and `forceEliminateCapOnBoard()`. [`ClientSandboxEngine.processLinesForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:1613) further wraps this with canonical Move-style decisions and trace-mode handling. | **Duplicated (semantics)**        | Both backend and sandbox have **full line-reward pipelines** independent of `LineMutator`, including exact-length vs overlength options and when to eliminate caps. The shared mutator already encodes canonical semantics; consolidation would replace multiple host engines and helper modules.       |
| Move-driven line decision phases & pending line-reward elimination flags               | Shared engine encodes line effects but not Move-driven decision-phase orchestration; turn/phase helpers in [`turnLogic.ts`](src/shared/engine/turnLogic.ts:1) assume hosts manage interactive phases.                                                                                                          | Backend `move-driven` path in [`GameEngine.applyDecisionMove()`](src/server/game/GameEngine.ts:1331) plus `_pendingLineRewardElimination` flag and `getValidMoves()` `line_processing` branch ([`GameEngine.getValidMoves()`](src/server/game/GameEngine.ts:2751)) orchestrate explicit `process_line` / `choose_line_reward` / `eliminate_rings_from_stack` moves.                                                                                                                                                                                                                                       | Sandbox uses `_pendingLineRewardElimination` ([`ClientSandboxEngine`](src/client/sandbox/ClientSandboxEngine.ts:170)) and [`ClientSandboxEngine.getValidEliminationDecisionMovesForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:1394) to surface elimination decisions after line rewards, with Move-driven flows wired through `applyCanonicalMoveInternal()`.                                     | **Host-specific but coordinated** | Move-driven line decision phases are intentionally host-level, but there is non-trivial duplicated logic around when to set/clear pending flags and how to transition between `line_processing`, `territory_processing`, and next turn. A small shared “line decision” module could reduce duplication. |

**NOTE**: The shared line validator/mutator pair (`LineValidator` + `LineMutator`) is already capable of enforcing Option 1 vs Option 2 semantics and legal collapsed-marker subsets. Most remaining duplication is around **Move enumeration and phase orchestration**, not the raw rules.

---

## 4. Territory (Detection & Processing)

| Area                                                                                                     | Shared canonical helper(s)                                                                                                                                                                                                                                                                                        | Backend code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Sandbox code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Status                                   | Notes                                                                                                                                                                                                                                                                 |
| -------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Disconnected-region detection (region geometry)                                                          | [`territoryDetection.findDisconnectedRegions()`](src/shared/engine/territoryDetection.ts:1)                                                                                                                                                                                                                       | [`BoardManager.findDisconnectedRegions()`](src/server/game/BoardManager.ts:907) delegates directly to `findDisconnectedRegionsShared()`. Legacy helpers (`findRegionsWithBorderColor()`, `findRegionsWithoutMarkerBorder()`) remain for reference only.                                                                                                                                                                                                                                         | [`sandboxTerritory.findDisconnectedRegionsOnBoard()`](src/client/sandbox/sandboxTerritory.ts:431) delegates directly to `findDisconnectedRegionsShared()`. Deprecated region-search helpers are retained but no longer used by the main export.                                                                                                                                                                                                                                                                                    | **Fully shared**                         | Region geometry and representation checks are single-sourced in the shared engine.                                                                                                                                                                                    |
| Border marker enumeration for a region                                                                   | [`territoryBorders.getBorderMarkerPositionsForRegion()`](src/shared/engine/territoryBorders.ts:1)                                                                                                                                                                                                                 | [`BoardManager.getBorderMarkerPositions()`](src/server/game/BoardManager.ts:1168) is a thin wrapper over `getSharedBorderMarkers(board, regionSpaces, { mode: 'rust_aligned' })`.                                                                                                                                                                                                                                                                                                               | [`sandboxTerritory.getBorderMarkerPositionsForRegion()`](src/client/sandbox/sandboxTerritory.ts:441) is a thin wrapper over `getSharedBorderMarkers(board, regionSpaces, { mode: 'rust_aligned' })`.                                                                                                                                                                                                                                                                                                                               | **Fully shared**                         | Border-finding logic is fully centralised; hosts only call the shared helper.                                                                                                                                                                                         |
| “Processable region” gating (self-elimination prerequisite, FAQ Q23)                                     | [`territoryProcessing.filterProcessableTerritoryRegions()`](src/shared/engine/territoryProcessing.ts:1), [`territoryProcessing.canProcessTerritoryRegion()`](src/shared/engine/territoryProcessing.ts:1), [`TerritoryValidator.validateProcessTerritory()`](src/shared/engine/validators/TerritoryValidator.ts:1) | [`RuleEngine.canProcessDisconnectedRegionForRules()`](src/server/game/RuleEngine.ts:1263) and [`GameEngine.canProcessDisconnectedRegion()`](src/server/game/GameEngine.ts:2070) wrap `canProcessTerritoryRegion()`. [`rules/territoryProcessing.processDisconnectedRegionsForCurrentPlayer()`](src/server/game/rules/territoryProcessing.ts:41) uses `filterProcessableTerritoryRegions()`.                                                                                                     | [`ClientSandboxEngine.canProcessDisconnectedRegion()`](src/client/sandbox/ClientSandboxEngine.ts:1313) wraps `canProcessTerritoryRegion()`. [`sandboxTerritoryEngine.getValidTerritoryProcessingMoves()`](src/client/sandbox/sandboxTerritoryEngine.ts:90) and [`processDisconnectedRegionsForCurrentPlayerEngine()`](src/client/sandbox/sandboxTerritoryEngine.ts:200) use host `canProcessRegion` delegates that ultimately call the shared helper.                                                                              | **Thin adapter**                         | The Q23 self-elimination prerequisite is consistently centralised in the shared module; host code is just plumbing and identity matching.                                                                                                                             |
| Territory region processing (internal eliminations + collapse + border-markers; **no** self-elimination) | [`territoryProcessing.applyTerritoryRegion()`](src/shared/engine/territoryProcessing.ts:1), [`TerritoryMutator.mutateProcessTerritory()`](src/shared/engine/mutators/TerritoryMutator.ts:1)                                                                                                                       | [`GameEngine.processDisconnectedRegionCore()`](src/server/game/GameEngine.ts:2097) delegates to `applyTerritoryRegion()` and then mirrors its deltas into `GameState.totalRingsEliminated` and player stats via `updatePlayerTerritorySpaces()` / `updatePlayerEliminatedRings()`. [`rules/territoryProcessing.processOneDisconnectedRegion()`](src/server/game/rules/territoryProcessing.ts:235) uses `applyTerritoryRegion()` similarly.                                                      | [`sandboxTerritory.processDisconnectedRegionCoreOnBoard()`](src/client/sandbox/sandboxTerritory.ts:454) delegates to `applyTerritoryRegion()`, then adjusts sandbox `Player` stats and `totalRingsEliminated`.                                                                                                                                                                                                                                                                                                                     | **Thin adapter**                         | The geometric and per-player-delta semantics of region processing are fully shared; hosts primarily map board-level deltas into their own `GameState` representations.                                                                                                |
| Mandatory self-elimination after processing a region                                                     | Concept (self-elimination owed after region processing) is reflected in `TerritoryMutator` and shared tests, but the **cap-elimination choice mechanics** intentionally live at host level.                                                                                                                       | [`rules/territoryProcessing.processOneDisconnectedRegion()`](src/server/game/rules/territoryProcessing.ts:235) applies `applyTerritoryRegion()` then immediately calls [`lineProcessing.eliminatePlayerRingOrCapWithChoice()`](src/server/game/rules/lineProcessing.ts:173). `GameEngine.applyDecisionMove()`’s `process_territory_region` / `eliminate_rings_from_stack` branches implement a Move-driven variant, using `_pendingTerritorySelfElimination` to track outstanding eliminations. | [`sandboxTerritory.processDisconnectedRegionOnBoard()`](src/client/sandbox/sandboxTerritory.ts:504) applies `processDisconnectedRegionCoreOnBoard()` then calls [`forceEliminateCapOnBoard()`](src/client/sandbox/sandboxElimination.ts:1). [`sandboxTerritoryEngine.processDisconnectedRegionsForCurrentPlayerEngine()`](src/client/sandbox/sandboxTerritoryEngine.ts:200) orchestrates region loops. `ClientSandboxEngine.applyCanonicalMoveInternal()` implements Move-driven variants with `_pendingTerritorySelfElimination`. | **Duplicated (choice/elimination flow)** | Self-elimination flows are implemented twice (backend & sandbox), each built on the common `applyTerritoryRegion()` core. Semantics are aligned, but maintaining both increases complexity, especially with the newer Move-driven `eliminate_rings_from_stack` model. |
| Early-sparse-board guard (“only mover has stacks”)                                                       | _(Not part of shared detection; implemented as host-level pre-filter.)_                                                                                                                                                                                                                                           | [`rules/territoryProcessing.processDisconnectedRegionsForCurrentPlayer()`](src/server/game/rules/territoryProcessing.ts:41) short-circuits when the moving player is the only player with stacks, to avoid collapsing the entire board early.                                                                                                                                                                                                                                                   | [`ClientSandboxEngine.processDisconnectedRegionsForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:1257) implements the same guard for sandbox territory processing.                                                                                                                                                                                                                                                                                                                                                   | **Host-specific but consistent**         | This guard is intentionally left host-side as a pre-filter before calling shared detection. Behaviour is mirrored in sandbox for parity.                                                                                                                              |

---

## 5. Placement (Validation & Dead-Placement)

| Area                                                                      | Shared canonical helper(s)                                                                                                                                                                                                                                                                      | Backend code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Sandbox code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Status                                                       | Notes                                                                                                                                                                                                                                                    |
| ------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Placement legality (geometry, capacity, no-dead-placement)                | [`PlacementValidator.validatePlacementOnBoard()`](src/shared/engine/validators/PlacementValidator.ts:1), [`PlacementValidator.validatePlacement()`](src/shared/engine/validators/PlacementValidator.ts:1), `hasAnyLegalMoveOrCaptureFromOnBoard()` via [`core.ts`](src/shared/engine/core.ts:1) | [`RuleEngine.validateRingPlacement()`](src/server/game/RuleEngine.ts:152) delegates to `validatePlacementOnBoard()` with a `PlacementContext` derived from `BOARD_CONFIGS` + `ringsInHand`. [`RuleEngine.getValidRingPlacements()`](src/server/game/RuleEngine.ts:830) enumerates positions/counts and calls `validatePlacementOnBoard()` for each candidate. [`RuleEngine.validateSkipPlacement()`](src/server/game/RuleEngine.ts:107) re-implements skip-availability checks instead of calling shared `validateSkipPlacement()`. | [`sandboxPlacement.enumerateLegalRingPlacements()`](src/client/sandbox/sandboxPlacement.ts:125) uses `validatePlacementOnBoard()` when a `PlacementContext` is provided (AI/parity flows), and a legacy board-only + no-dead-placement path otherwise. [`ClientSandboxEngine.tryPlaceRings()`](src/client/sandbox/ClientSandboxEngine.ts:1672) performs its own geometry + no-dead-placement checks via `createHypotheticalBoardWithPlacement()` and `hasAnyLegalMoveOrCaptureFrom()`, rather than calling `validatePlacementOnBoard()`. | **Mixed: largely shared, but duplicated in hosts**           | Capacity and no-dead-placement semantics are centralised, but sandbox interactive placement (`tryPlaceRings`) and backend skip-availability logic (`validateSkipPlacement`) still re-encode subsets of these rules.                                      |
| Placement application (stack mutation + ringsInHand bookkeeping)          | [`PlacementMutator.applyPlacementOnBoard()`](src/shared/engine/mutators/PlacementMutator.ts:1), [`PlacementMutator.mutatePlacement()`](src/shared/engine/mutators/PlacementMutator.ts:1)                                                                                                        | [`GameEngine.applyMove()`](src/server/game/GameEngine.ts:825) branch for `'place_ring'` manually merges rings into stacks, recalculates `capHeight`, and decrements `ringsInHand`. It also allows multi-ring placement by repeating the ring value `placementCount` times.                                                                                                                                                                                                                                                          | [`ClientSandboxEngine.tryPlaceRings()`](src/client/sandbox/ClientSandboxEngine.ts:1672) and the `bypassNoDeadPlacement` path in [`applyCanonicalMoveInternal()`](src/client/sandbox/ClientSandboxEngine.ts:1799) implement their own stack merge logic, marker clearing, and `ringsInHand` decrements for placements.                                                                                                                                                                                                                    | **Duplicated (mutators)**                                    | Both backend and sandbox directly mutate stacks and ring counts for placements, rather than calling `PlacementMutator`. Behaviour is aligned but centralisation would reduce drift risk.                                                                 |
| Skip-placement legality (optional placement when movement/capture exists) | [`PlacementValidator.validateSkipPlacement()`](src/shared/engine/validators/PlacementValidator.ts:1)                                                                                                                                                                                            | [`RuleEngine.validateSkipPlacement()`](src/server/game/RuleEngine.ts:107) mirrors shared semantics (phase is `ring_placement`, player has rings in hand, has at least one stack, and some stack has a legal move/capture via `hasAnyLegalMoveOrCaptureFromOnBoard()`), but does not call `validateSkipPlacement()`. `getValidMoves()` ring_placement branch synthesises a `skip_placement` move and asks this local validator.                                                                                                      | Sandbox has no interactive skip-placement; canonical replay path in [`ClientSandboxEngine.applyCanonicalMoveInternal()`](src/client/sandbox/ClientSandboxEngine.ts:1895) accepts any `skip_placement` move and simply flips phase to `movement`, without enforcing the shared skip invariants.                                                                                                                                                                                                                                           | **Backend duplication; sandbox divergence (canonical only)** | Backend reimplements shared skip semantics; sandbox only uses skip in canonical/debug flows and does not currently enforce the shared contract. Consolidation would likely add a small shared `SkipPlacementValidator` helper and wire both hosts to it. |

---

## 6. Victory / Stalemate

| Area                                                                                              | Shared canonical helper(s)                                              | Backend code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                            | Sandbox code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                                                                        | Status                           | Notes                                                                                                                                                                                                                        |
| ------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Victory / stalemate evaluation (ring-elimination, territory-control, structural stalemate ladder) | [`victoryLogic.evaluateVictory()`](src/shared/engine/victoryLogic.ts:1) | [`RuleEngine.checkGameEnd()`](src/server/game/RuleEngine.ts:719) delegates to `evaluateVictory()` and maps its result into a `{ isGameOver, winner?, reason? }` structure for `GameEngine`. [`GameEngine.resolveBlockedStateForCurrentPlayerForTesting()`](src/server/game/GameEngine.ts:2931) additionally applies hand→eliminated conversion in some blocked states, then re-calls `checkGameEnd()` for diagnostics. | [`sandboxVictory.checkSandboxVictory()`](src/client/sandbox/sandboxVictory.ts:70) delegates to `evaluateVictory()` and wraps it into a UI-facing `GameResult` (ring counts, territory, markers). [`sandboxGameEnd.checkAndApplyVictorySandbox()`](src/client/sandbox/sandboxGameEnd.ts:1) (via [`ClientSandboxEngine.checkAndApplyVictory()`](src/client/sandbox/ClientSandboxEngine.ts:1458)) uses `evaluateVictory()` as the single source of victory detection. | **Fully shared (core decision)** | All victory/stalemate decisions are driven by `evaluateVictory()`; host code only packages the result and, in tests, applies extra conversions (e.g. treating rings in hand as eliminated in certain structural stalemates). |
| Mapping shared verdict into terminal `GameResult` + GameState                                     | _(No single shared wrapper; this is intentionally host-specific.)_      | [`GameEngine.endGame()`](src/server/game/GameEngine.ts:2488) sets `gameStatus`, `winner`, normalises `currentPhase` away from `line_processing`/`territory_processing`, stops timers, and composes a `GameResult` with ring/territory/ringsRemaining summary.                                                                                                                                                          | [`sandboxVictory.buildGameResult()`](src/client/sandbox/sandboxVictory.ts:95) + [`sandboxGameEnd.resolveGlobalStalemateIfNeededSandbox()`](src/client/sandbox/sandboxGameEnd.ts:1) (called from `checkAndApplyVictorySandbox()`) build sandbox `GameResult` summaries and normalise phases similarly. [`ClientSandboxEngine.checkAndApplyVictory()`](src/client/sandbox/ClientSandboxEngine.ts:1458) applies the result and stores `victoryResult`.                | **Host-specific**                | Host-level terminal bookkeeping (timers, DB updates, AI diagnostics, UI-specific score summaries) is intentionally not centralised; only the underlying win/stalemate predicate is shared.                                   |

**NOTE**: Backend’s [`GameEngine.resolveBlockedStateForCurrentPlayerForTesting()`](src/server/game/GameEngine.ts:2931) is explicitly **test-only** and intentionally re-derives some structural stalemate logic (including hand→eliminated conversion) for safety nets in AI simulations. This does not need to be centralised into the shared engine.

---

## 7. Turn Sequencing & Phases

| Area                                                                                         | Shared canonical helper(s)                                                                                                                              | Backend code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Sandbox code paths still implementing logic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Status                               | Notes                                                                                                                                                                                                                                                                                      |
| -------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Core turn/phase state machine (phase transitions, forced elimination hooks, player rotation) | [`turnLogic.advanceTurnAndPhase()`](src/shared/engine/turnLogic.ts:1), [`TurnMutator`](src/shared/engine/mutators/TurnMutator.ts:1)                     | [`TurnEngine.advanceGameForCurrentPlayer()`](src/server/game/turn/TurnEngine.ts:1) (not shown here but imported into [`GameEngine.advanceGame()`](src/server/game/GameEngine.ts:2186)) adapts backend-specific delegates (`hasAnyPlacement`, `hasAnyMovement`, `hasAnyCapture`, `applyForcedElimination`, `getNextPlayerNumber`) into `TurnLogicDelegates`.                                                                                                                                                                                                                                        | [`sandboxTurnEngine.advanceTurnAndPhaseForCurrentPlayerSandbox()`](src/client/sandbox/sandboxTurnEngine.ts:81) is an explicit adapter over `advanceTurnAndPhase()` with sandbox-specific delegates, used from [`ClientSandboxEngine.advanceTurnAndPhaseForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:867).                                                                                                                                                                                                                                                                                            | **Thin adapter**                     | The actual state machine is fully shared; duplication here is limited to host-specific delegates (how to check for any placements/movements/captures and how to perform elimination/victory checks).                                                                                       |
| Start-of-turn handling & forced elimination for blocked players                              | [`turnLogic`](src/shared/engine/turnLogic.ts:1) encodes expectations but not concrete host actions (it calls `applyForcedElimination` delegate).        | [`GameEngine.hasValidActions()`](src/server/game/GameEngine.ts:2286), [`GameEngine.hasValidPlacements()`](src/server/game/GameEngine.ts:2298), [`GameEngine.hasValidMovements()`](src/server/game/GameEngine.ts:2312), and [`GameEngine.processForcedElimination()`](src/server/game/GameEngine.ts:2371) implement backend-specific checks and forced elimination, then feed into the shared turn engine via `TurnEngineDeps`/`TurnEngineHooks`.                                                                                                                                                   | [`sandboxTurnEngine.startTurnForCurrentPlayerSandbox()`](src/client/sandbox/sandboxTurnEngine.ts:164) and [`maybeProcessForcedEliminationForCurrentPlayerSandbox()`](src/client/sandbox/sandboxTurnEngine.ts:228) implement sandbox-specific start-of-turn and forced-elimination behaviours, using `hooks.enumerateLegalRingPlacements()` and `hooks.hasAnyLegalMoveOrCaptureFrom()`. [`ClientSandboxEngine.startTurnForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:828) and [`maybeProcessForcedEliminationForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:847) act as thin wrappers. | **Partially duplicated (delegates)** | Hosts must supply delegates, so some duplication is expected. However, backend still partially relies on its legacy `hasValidMovements()`/`hasValidPlacements()` instead of shared `hasAnyLegalMoveOrCaptureFromOnBoard()`, whereas sandbox delegates are already built on shared helpers. |
| Automatic vs move-driven bookkeeping phases (`line_processing`, `territory_processing`)      | Turn/phase progression rules are in [`turnLogic`](src/shared/engine/turnLogic.ts:1), but interactive bookkeeping phases are intentionally host-managed. | [`GameEngine.processAutomaticConsequences()`](src/server/game/GameEngine.ts:1138) calls shared-backed helpers [`rules/territoryProcessing.processDisconnectedRegionsForCurrentPlayer()`](src/server/game/rules/territoryProcessing.ts:41) and [`rules/lineProcessing.processLinesForCurrentPlayer()`](src/server/game/rules/lineProcessing.ts:30) in legacy automatic mode; `useMoveDrivenDecisionPhases` + `applyDecisionMove()` implement the Move-driven variant. [`GameEngine.stepAutomaticPhasesForTesting()`](src/server/game/GameEngine.ts:3137) auto-advances bookkeeping phases in tests. | [`ClientSandboxEngine.advanceAfterMovement()`](src/client/sandbox/ClientSandboxEngine.ts:1206) directly calls sandbox line and territory engines (`processLinesForCurrentPlayer`, `processDisconnectedRegionsForCurrentPlayer`), then normalises to `territory_processing` and hands off to `sandboxTurnEngine.advanceTurnAndPhaseForCurrentPlayerSandbox()`. Trace-mode branches switch to explicit `line_processing`/`territory_processing` phases using canonical decision Moves.                                                                                                                                   | **Host-specific**                    | The exact sequencing of automatic vs explicit decision phases is host-dependent (backend WebSocket vs sandbox UI vs tests). Semantics are aligned but the orchestration (when to stop for a decision vs when to auto-apply) is necessarily duplicated.                                     |

---

## 8. Summary & Recommendations for Subtask #6

### 8.1 Most Important Remaining Duplications

1. **Movement & capture mutators (backend vs sandbox vs shared mutators)**
   - **Files / functions:**
     - Shared: [`MovementMutator.mutateMovement()`](src/shared/engine/mutators/MovementMutator.ts:1), [`CaptureMutator.mutateCapture()`](src/shared/engine/mutators/CaptureMutator.ts:1), [`core.applyMarkerEffectsAlongPathOnBoard()`](src/shared/engine/core.ts:1).
     - Backend: movement/capture branches in [`GameEngine.applyMove()`](src/server/game/GameEngine.ts:825) and [`GameEngine.performOvertakingCapture()`](src/server/game/GameEngine.ts:1051), plus [`GameEngine.processMarkersAlongPath()`](src/server/game/GameEngine.ts:2153) and landing-on-own-marker elimination in [`eliminateTopRingAt()`](src/server/game/GameEngine.ts:1929).
     - Sandbox: [`sandboxMovementEngine.handleMovementClickSandbox()`](src/client/sandbox/sandboxMovementEngine.ts:120), [`sandboxCaptures.applyCaptureSegmentOnBoard()`](src/client/sandbox/sandboxCaptures.ts:98), [`sandboxMovementEngine.applyCaptureSegmentWithHooks()`](src/client/sandbox/sandboxMovementEngine.ts:574), and elimination logic in [`ClientSandboxEngine.applyCaptureSegment()`](src/client/sandbox/ClientSandboxEngine.ts:701).
   - **Recommendation:** Introduce **adapter-grade shared mutators** for both simple movement and overtaking capture that operate on a `BoardState` + minimal view interfaces (like the existing mutators), and refactor backend/sandbox to call them instead of hand-rolling stack/marker/elimination updates.

2. **Line reward resolution & elimination (multiple engines vs `LineMutator`)**
   - **Files / functions:**
     - Shared: [`LineMutator.mutateProcessLine()`](src/shared/engine/mutators/LineMutator.ts:1), [`LineMutator.mutateChooseLineReward()`](src/shared/engine/mutators/LineMutator.ts:1), [`LineValidator`](src/shared/engine/validators/LineValidator.ts:1).
     - Backend: legacy line processing in [`GameEngine.processLineFormations()` / `processOneLine()` / `collapseLineMarkers()` / `eliminatePlayerRingOrCap*`](src/server/game/GameEngine.ts:1709) and modern pipeline in [`rules/lineProcessing.processLinesForCurrentPlayer()`](src/server/game/rules/lineProcessing.ts:30).
     - Sandbox: [`sandboxLinesEngine.processLinesForCurrentPlayer()`](src/client/sandbox/sandboxLinesEngine.ts:326), [`sandboxLinesEngine.applyLineDecisionMove()`](src/client/sandbox/sandboxLinesEngine.ts:213), and [`ClientSandboxEngine.processLinesForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:1613).
   - **Recommendation:**
     - a) Create a **shared “line decision engine”** that exposes `getValidLineProcessingMoves(state)` and `applyLineDecisionMove(state, move)` built directly on `LineValidator` + `LineMutator`.
     - b) Retire backend `rules/lineProcessing` and sandbox `sandboxLinesEngine` logic in favour of that shared module, leaving only host-specific UI/choice wiring.

3. **Territory region processing + self-elimination orchestration**
   - **Files / functions:**
     - Shared: [`territoryProcessing.applyTerritoryRegion()`](src/shared/engine/territoryProcessing.ts:1), [`TerritoryMutator`](src/shared/engine/mutators/TerritoryMutator.ts:1).
     - Backend: [`rules/territoryProcessing.processDisconnectedRegionsForCurrentPlayer()`](src/server/game/rules/territoryProcessing.ts:41), [`processOneDisconnectedRegion()`](src/server/game/rules/territoryProcessing.ts:235), [`GameEngine.processDisconnectedRegionCore()`](src/server/game/GameEngine.ts:2097), and territory-related branches in [`GameEngine.applyDecisionMove()`](src/server/game/GameEngine.ts:1331).
     - Sandbox: [`sandboxTerritory.processDisconnectedRegionCoreOnBoard()`](src/client/sandbox/sandboxTerritory.ts:454), [`sandboxTerritory.processDisconnectedRegionOnBoard()`](src/client/sandbox/sandboxTerritory.ts:504), [`sandboxTerritoryEngine.processDisconnectedRegionsForCurrentPlayerEngine()`](src/client/sandbox/sandboxTerritoryEngine.ts:200), and `process_territory_region` / `eliminate_rings_from_stack` handling in [`ClientSandboxEngine.applyCanonicalMoveInternal()`](src/client/sandbox/ClientSandboxEngine.ts:1799).
   - **Recommendation:**
     - a) Extend the shared territory module with a **higher-level helper** that combines `applyTerritoryRegion()` with **canonical self-elimination mutation** (parameterised by “territory vs line reward” origin if necessary).
     - b) Move Move-driven decision semantics for `process_territory_region` / `eliminate_rings_from_stack` into a **shared “territory decision engine”**, then have both backend and sandbox use it for enumeration and application.

4. **Placement application and skip-availability semantics**
   - **Files / functions:**
     - Shared: [`PlacementValidator.validatePlacementOnBoard()`](src/shared/engine/validators/PlacementValidator.ts:1), [`PlacementValidator.validateSkipPlacement()`](src/shared/engine/validators/PlacementValidator.ts:1), [`PlacementMutator`](src/shared/engine/mutators/PlacementMutator.ts:1).
     - Backend: placement branch in [`GameEngine.applyMove()`](src/server/game/GameEngine.ts:825), [`RuleEngine.validateSkipPlacement()`](src/server/game/RuleEngine.ts:107), and `getValidRingPlacements()` implementation in [`RuleEngine`](src/server/game/RuleEngine.ts:830).
     - Sandbox: [`ClientSandboxEngine.tryPlaceRings()`](src/client/sandbox/ClientSandboxEngine.ts:1672) and the placement part of [`applyCanonicalMoveInternal()`](src/client/sandbox/ClientSandboxEngine.ts:1799), plus `enumerateLegalRingPlacements()` in [`sandboxPlacement`](src/client/sandbox/sandboxPlacement.ts:125).
   - **Recommendation:**
     - a) Refactor both hosts to call `PlacementMutator.applyPlacementOnBoard()` / `mutatePlacement()` for stack and supply updates.
     - b) Replace backend `validateSkipPlacement()` and sandbox canonical skip handling with a call to shared `validateSkipPlacement()` and expose a shared helper for enumerating `skip_placement` moves when legal.

5. **Line and territory decision-move enumeration (`process_*`, `choose_line_reward`, `eliminate_rings_from_stack`)**
   - **Files / functions:**
     - Backend: [`GameEngine.getValidLineProcessingMoves()`](src/server/game/GameEngine.ts:1190), [`GameEngine.getValidTerritoryProcessingMoves()`](src/server/game/GameEngine.ts:1277), [`RuleEngine.getValidLineProcessingDecisionMoves()`](src/server/game/RuleEngine.ts:1076), [`RuleEngine.getValidTerritoryProcessingDecisionMoves()`](src/server/game/RuleEngine.ts:1138), [`RuleEngine.getValidEliminationDecisionMoves()`](src/server/game/RuleEngine.ts:1190).
     - Sandbox: [`sandboxLinesEngine.getValidLineProcessingMoves()`](src/client/sandbox/sandboxLinesEngine.ts:143), [`sandboxTerritoryEngine.getValidTerritoryProcessingMoves()`](src/client/sandbox/sandboxTerritoryEngine.ts:90), [`ClientSandboxEngine.getValidLineProcessingMovesForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:1569), [`ClientSandboxEngine.getValidTerritoryProcessingMovesForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:1345), [`ClientSandboxEngine.getValidEliminationDecisionMovesForCurrentPlayer()`](src/client/sandbox/ClientSandboxEngine.ts:1394).
   - **Recommendation:** Provide **shared, stateless enumerators** for all decision move types (lines & territory, including elimination) that operate purely on `GameState` and shared validators/mutators. Backend `getValidMoves()` and sandbox debug/AI tooling would then call these, eliminating many parallel implementations.

6. **Backend-only “has valid movements” turn-gating (`hasValidMovements`)**
   - **Files / functions:**
     - [`GameEngine.hasValidMovements()`](src/server/game/GameEngine.ts:2312) and [`hasValidActions()`](src/server/game/GameEngine.ts:2286).
   - **Recommendation:** Replace this legacy BFS with a delegate that uses `hasAnyLegalMoveOrCaptureFromOnBoard()` or movement enumerators, matching the shared geometry used for actual move legality. This will remove a subtle source of potential parity drift in forced-elimination and phase-selection logic.

### 8.2 Ambiguous / Host-Specific Logic

**NOTE – Test-only blockage resolvers and parity tooling**

- Backend [`GameEngine.resolveBlockedStateForCurrentPlayerForTesting()`](src/server/game/GameEngine.ts:2931) and sandbox `traceMode`-specific branches in [`ClientSandboxEngine`](src/client/sandbox/ClientSandboxEngine.ts:1206) are **explicitly diagnostic/test-only**:
  - They re-derive some structural stalemate handling and perform additional `checkGameEnd()` calls.
  - They are not part of the normal WebSocket/sandbox UX paths.
- These helpers are intentionally host-specific and do not need to be centralised, but they should be kept in sync with shared `evaluateVictory()` and turn logic by tests.

**NOTE – AI and UX wiring**

- Backend AI integration (Python rules service, local fallback) and sandbox AI heuristics (e.g. [`maybeRunAITurnSandbox`](src/client/sandbox/sandboxAI.ts:1)) purposefully live outside the shared engine.
- They consume shared helpers (enumerators, validators) but introduce host-specific policies (e.g. how to choose among legal moves, when to fall back). These policies are **not candidates** for centralisation in Subtask #6.

---

This audit should be used as the **source of truth** for identifying which backend/sandbox rule paths still need to be migrated to shared helpers in order to complete the rules-engine consolidation and ensure long-term parity between hosts and the canonical shared engine.
